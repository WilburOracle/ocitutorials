<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="ja" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Oracle Container Engine for Kubernetes(OKE)でサンプルマイクロサービスアプリケーションをデプロイしてOCIのオブザバビリティサービスを利用してみよう | Oracle Cloud Infrastructure チュートリアル</title>
<meta name="description" content="OKEを使ってサンプルマイクロサービスアプリケーションのデプロイおよびオブザバビリティを体験していただけるコンテンツです。OCIのオブザバビリティサービスであるMonitoring、Logging、Application Performance Monitoring、Notificationsを利用します。">


  <meta name="author" content="Oracle Japan Solution Engineers">
  
  <meta property="article:author" content="Oracle Japan Solution Engineers">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="ja_JP">
<meta property="og:site_name" content="Oracle Cloud Infrastructure チュートリアル">
<meta property="og:title" content="Oracle Container Engine for Kubernetes(OKE)でサンプルマイクロサービスアプリケーションをデプロイしてOCIのオブザバビリティサービスを利用してみよう">
<meta property="og:url" content="https://oracle-japan.github.io/ocitutorials/cloud-native/oke-observability-for-advances/">


  <meta property="og:description" content="OKEを使ってサンプルマイクロサービスアプリケーションのデプロイおよびオブザバビリティを体験していただけるコンテンツです。OCIのオブザバビリティサービスであるMonitoring、Logging、Application Performance Monitoring、Notificationsを利用します。">



  <meta property="og:image" content="https://oracle-japan.github.io/ocitutorials/assets/images/rh01-cloud-home-pine-background.jpg">





  <meta property="article:published_time" content="2022-02-22T11:00:06+09:00">






<link rel="canonical" href="https://oracle-japan.github.io/ocitutorials/cloud-native/oke-observability-for-advances/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "https://oracle-japan.github.io/ocitutorials/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/ocitutorials/feed.xml" type="application/atom+xml" rel="alternate" title="Oracle Cloud Infrastructure チュートリアル Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/ocitutorials/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/ocitutorials/"><img src="/ocitutorials/assets/images/social-og-oracle-badge.jpg" alt="OCI チュートリアル"></a>
        
        <a class="site-title" href="/ocitutorials/">
          OCI チュートリアル
          <span class="site-subtitle">Oracle Cloud Infrastructure を使ってみよう</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/ocitutorials/beginners/" title="OCIをはじめて使う人のための基本的なチュートリアル">入門編</a>
            </li><li class="masthead__menu-item">
              <a href="/ocitutorials/intermediates/" title="OCIをもっと活用するためのチュートリアル">応用編</a>
            </li><li class="masthead__menu-item">
              <a href="/ocitutorials/database/" title="Oracle Databaseをクラウドで使うためのチュートリアル">Oracle DB編</a>
            </li><li class="masthead__menu-item">
              <a href="/ocitutorials/cloud-native/" title="OCIで Cloud Nativeなアプリケーション開発を行うためのチュートリアル">Cloud Native編</a>
            </li><li class="masthead__menu-item">
              <a href="/ocitutorials/content-management/" title="OCIのコンテンツ管理サービスを使う人のためのチュートリアル">コンテンツ管理編</a>
            </li><li class="masthead__menu-item">
              <a href="/ocitutorials/blockchain/" title="OCIのコンテンツ管理サービスを使う人のためのチュートリアル">ブロックチェーン編</a>
            </li><li class="masthead__menu-item">
              <a href="/ocitutorials/enterprise/" title="エンタープライズなアプリケーションを構築、運用するためのチュートリアル">エンタープライズ編</a>
            </li><li class="masthead__menu-item">
              <a href="/ocitutorials/integration/" title="OICのチュートリアル">インテグレーション編</a>
            </li><li class="masthead__menu-item">
              <a href="/ocitutorials/datascience/" title="OCIのデータサイエンス/ビッグデータ関連サービスのチュートリアル">データサイエンス/ビッグデータ編</a>
            </li><li class="masthead__menu-item">
              <a href="/ocitutorials/about/">このサイトについて</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">メニュー</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      
  







<div class="page__hero--overlay"
  style=" background-image: url('/ocitutorials/assets/images/rh01-cloud-home-pine-background.jpg');"
>
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline">
        
          Oracle Container Engine for Kubernetes(OKE)でサンプルマイクロサービスアプリケーションをデプロイしてOCIのオブザバビリティサービスを利用してみよう

        
      </h1>
      
        <p class="page__lead">OKEを使ってサンプルマイクロサービスアプリケーションのデプロイおよびオブザバビリティを体験していただけるコンテンツです。OCIのオブザバビリティサービスであるMonitoring、Logging、Application Performance Monitoring、Notificationsを利用します。
</p>
      
      


      
      
    </div>
  
  
</div>




  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="https://oracle-japan.github.io/ocitutorials/" itemprop="item"><span itemprop="name">ホーム</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">></span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/ocitutorials/cloud-native" itemprop="item"><span itemprop="name">Cloud native</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">></span>
      
    
      
      
        <li class="current">Oracle Container Engine for Kubernetes(OKE)でサンプルマイクロサービスアプリケーションをデプロイしてOCIのオブザバビリティサービスを利用してみよう</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">メニュー</label>
  <ul class="nav__items">
    <li>
      
      <a href=""><span class="nav__sub-title">Cloud Native編</span></a>
      <ul>
        
        
          <p></p><li><a href="/ocitutorials/cloud-native/devops-for-commons/">Oracle Cloud Infrastructure(OCI) DevOpsことはじめ</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/oke-for-commons/">Oracle Container Engine for Kubernetes(OKE)をプロビジョニングしよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/oke-for-beginners/">Oracle Container Engine for Kubernetes(OKE)でKubernetesを動かしてみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/oke-for-intermediates/">KubernetesでサンプルアプリケーションのデプロイとCI/CDを体験してみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/oke-for-advances/">Oracle Container Engine for Kubernetes(OKE)でサンプルマイクロサービスアプリケーションをデプロイしてオブザバビリティツールを利用してみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/oke-observability-for-advances/" class="active">Oracle Container Engine for Kubernetes(OKE)でサンプルマイクロサービスアプリケーションをデプロイしてOCIのオブザバビリティサービスを利用してみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/fn-for-beginners/">Fn Project ハンズオン</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/functions-for-beginners/">Oracle Functions ハンズオン</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/functions-apigateway-for-beginners/">Oracle Cloud Infrasturcture API Gateway + Oracle Functionsハンズオン</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/functions-vmshape-for-intermediates/">Oracle Functionsを利用した仮想マシン (VM) のシェイプ変更</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/functions-ords-for-intermediates/">Oracle Functionsを利用したORDSでのデータベースアクセス</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/functions-nosql-for-intermediates/">Oracle Functionsを利用したNoSQLデータベースアクセス</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/functions-apigateway-for-intermediates/">Oracle Functionsを利用したAPI Gatewayの認証</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/apigateway-for-beginners/">OCI API Gatewayハンズオン</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/helidon-mp-for-beginners/">Helidon(MP)を始めてみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/helidon-se-for-beginners/">Helidon(SE)を始めてみよう</a></li></p>
        
      </ul>
    </li>
  </ul>
</nav>
    
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Oracle Container Engine for Kubernetes(OKE)でサンプルマイクロサービスアプリケーションをデプロイしてOCIのオブザバビリティサービスを利用してみよう">
    <meta itemprop="description" content="OKEを使ってサンプルマイクロサービスアプリケーションのデプロイおよびオブザバビリティを体験していただけるコンテンツです。OCIのオブザバビリティサービスであるMonitoring、Logging、Application Performance Monitoring、Notificationsを利用します。">
    <meta itemprop="datePublished" content="2022-02-22T11:00:06+09:00">
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> 目次</h4></header>
              <ul class="toc__menu"><li><a href="#1okeクラスタ構築とocirセットアップ">1.OKEクラスタ構築とOCIRセットアップ</a><ul><li><a href="#1-1-ociダッシュボードからokeクラスタの構築">1-1 OCIダッシュボードからOKEクラスタの構築</a></li><li><a href="#1-2-cloud-shellを利用してクラスタを操作">1-2 Cloud Shellを利用してクラスタを操作</a></li><li><a href="#1-3-ocirのセットアップ">1-3 OCIRのセットアップ</a></li></ul></li><li><a href="#2application-performance-monitoring">2.Application Performance Monitoring</a><ul><li><a href="#2-1-サンプルアプリケーションの概要説明">2-1. サンプルアプリケーションの概要説明</a></li><li><a href="#2-2-サンプルアプリケーションとapm連携設定">2-2 サンプルアプリケーションとAPM連携設定</a></li><li><a href="#2-3-apmドメインの作成">2-3 APMドメインの作成</a></li><li><a href="#2-4-サンプルアプリケーションのビルドとコンテナイメージシップ">2-4 サンプルアプリケーションのビルドとコンテナイメージシップ</a></li><li><a href="#2-5-サンプルアプリケーションのmanifest設定の変更">2-5 サンプルアプリケーションのManifest設定の変更</a></li><li><a href="#2-6-oci-apmでのトレーシング">2-6 OCI APMでのトレーシング</a></li><li><a href="#2-7-oci-apmでのアプリケーションサーバのメトリクス監視">2-7 OCI APMでのアプリケーションサーバのメトリクス監視</a></li></ul></li><li><a href="#3logging">3.Logging</a><ul><li><a href="#3-1-カスタムログの設定">3-1 カスタム・ログの設定</a><ul><li><a href="#動的グループの作成">動的グループの作成</a></li><li><a href="#ポリシー設定">ポリシー設定</a></li><li><a href="#カスタムログ設定">カスタム・ログ設定</a></li></ul></li><li><a href="#3-2-ワーカーノード上のアプリケーションログの確認">3-2 ワーカーノード上のアプリケーションログの確認</a></li><li><a href="#3-3-kubernetes-apiサーバーの監査ログの確認">3-3 Kubernetes APIサーバーの監査ログの確認</a></li></ul></li><li><a href="#monitoring--notifications">Monitoring &amp; Notifications</a><ul><li><a href="#4-1-notificationsの設定">4-1 Notificationsの設定</a></li><li><a href="#4-2-monitoringの設定">4-2 Monitoringの設定</a></li><li><a href="#4-3-monitoringとnotificationsの実践">4-3 MonitoringとNotificationsの実践</a><ul><li><a href="#jmeterサーバの構築">jmeterサーバの構築</a></li><li><a href="#jmeter環境のセットアップ">jmeter環境のセットアップ</a></li><li><a href="#状況の確認">状況の確認</a></li></ul></li></ul></li></ul>

            </nav>
          </aside>
        
        <p>このハンズオンでは、Oracle Container Engine for Kubernetes（以下OKE）上に、マイクロサービスアプリケーションをデプロイします。そして、OCIのObservabilityサービスを利用して、モニタリング、ロギング、トレーシングを実践的に学びます。</p>

<p>OCIのObservabilityサービスとして、以下を利用します。</p>

<p><strong><em>モニタリング</em></strong></p>

<ul>
  <li><a href="https://www.oracle.com/jp/devops/monitoring/">Oracle Cloud Infrastructure Monitoring</a></li>
</ul>

<p><strong><em>ロギング</em></strong></p>

<ul>
  <li><a href="https://www.oracle.com/jp/devops/logging/">Oracle Cloud Infrastructure Logging</a></li>
</ul>

<p><strong><em>トレーシング</em></strong></p>

<ul>
  <li><a href="https://www.oracle.com/jp/manageability/">Oracle Cloud Observability and Management Platform</a></li>
</ul>

<p>Oracle Cloud Observability and Management Platform サービスの一つである分散トレーシングや合成モニタリングなど実現する Oracle Cloud Infrastrucutre Application Performance Monitoring（APM） を利用します。</p>

<p>ハンズオンの流れは以下となります。</p>

<hr />
<ol>
  <li>OKEクラスタ構築とOCIRセットアップ
    <ol>
      <li>OCIダッシュボードからOKEクラスタの構築</li>
      <li>Cloud Shellを利用してクラスタを操作</li>
      <li>OCIRのセットアップ</li>
    </ol>
  </li>
  <li>Application Performance Monitoring
    <ol>
      <li>サンプルアプリケーションの概要説明</li>
      <li>サンプルアプリケーションとAPM連携設定</li>
      <li>APMドメインの作成</li>
      <li>サンプルアプリケーションのビルドとコンテナイメージシップ</li>
      <li>サンプルアプリケーションのManifest設定の変更</li>
      <li>OCI APMでのトレーシング</li>
      <li>OCI APMでのアプリケーションサーバのメトリクス監視</li>
    </ol>
  </li>
  <li>Logging
    <ol>
      <li>カスタム・ログの設定</li>
      <li>ワーカーノード上のアプリケーションログの確認</li>
      <li>Kubernetes APIサーバーの監査ログの確認</li>
    </ol>
  </li>
  <li>Monitoring &amp; Notifications
    <ol>
      <li>Notificationsの設定</li>
      <li>Monitoringの設定</li>
      <li>MonitoringとNotificationsの実践</li>
    </ol>
  </li>
</ol>

<hr />

<h2 id="1okeクラスタ構築とocirセットアップ">1.OKEクラスタ構築とOCIRセットアップ</h2>

<h3 id="1-1-ociダッシュボードからokeクラスタの構築">1-1 OCIダッシュボードからOKEクラスタの構築</h3>

<p>左上のハンバーガーメニューを展開して、「開発者サービス」から「Kubernetesクラスタ(OKE)」を選択します。</p>

<p><img src="1-1-001.png" alt="" /></p>

<p>左メニューにある「リスト範囲」のコンパートメント選択プルダウンメニューからご自身のコンパートメントを選択します。</p>

<p><img src="1-1-012.png" alt="" /></p>

<p>「クラスタの作成」ボタンをクリックします。</p>

<p><img src="1-1-002.png" alt="" /></p>

<p>「クイック作成」が選択されていることを確認して、「ワークフローの起動」ボタンをクリックします。</p>

<p><img src="1-1-003.png" alt="" /></p>

<p>以下を設定の設定となっていることを確認します。</p>

<p>「Kubernetes APIエンドポイント」:「パブリック・ワーカー」
「Kubernetesワーカー・ノード」:「プライベート・ワーカー」
「シェイプ」：「VM Standard.E3.Flex」
「OCPU数の選択」:「1」
「メモリー量（GB）」：「16」</p>

<p><img src="1-1-004.png" alt="" /></p>

<p>画面左下の「次」ボタンをクリックします。</p>

<p><img src="1-1-005.png" alt="" /></p>

<p>画面左下の「クラスタ作成」ボタンをクリックします。</p>

<p><img src="1-1-006.png" alt="" /></p>

<p>画面左下の「閉じる」ボタンをクリックします。</p>

<p><img src="1-1-007.png" alt="" /></p>

<p>黄色の「作成中」から緑の「アクティブ」になることを確認します。「アクティブ」であればクラスタ作成は完了です。</p>

<p><img src="1-1-008.png" alt="" /></p>

<h3 id="1-2-cloud-shellを利用してクラスタを操作">1-2 Cloud Shellを利用してクラスタを操作</h3>

<p>Cloud Shellを利用して、作成したKubernetesクラスタに接続します。</p>

<p>「クラスタへのアクセス」ボタンをクリックします。</p>

<p><img src="1-1-009.png" alt="" /></p>

<p>「Cloud Shellの起動」ボタン、「コピー」リンクテキスト、「閉じる」ボタンの順にクリックします。</p>

<p><img src="1-1-010.png" alt="" /></p>

<p>Cloud Shell起動後、「コピー」した内容をペーストして、Enterキーを押します。</p>

<p><img src="1-1-011.png" alt="" /></p>

<p>以下コマンドを実行して、3ノードの「STATUS」が「Ready」になっていることを確認します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get nodes
</code></pre></div></div>
<p><strong><em>コマンド結果</em></strong></p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME          STATUS   ROLES   AGE     VERSION
10.0.10.139   Ready    node    2m7s    v1.21.5
10.0.10.228   Ready    node    2m22s   v1.21.5
10.0.10.24    Ready    node    2m27s   v1.21.5
</code></pre></div></div>

<h3 id="1-3-ocirのセットアップ">1-3 OCIRのセットアップ</h3>

<p>後続手順で、サンプルアプリケーションをビルドして、コンテナイメージを作成します。<br />
そのコンテナイメージを格納するコンテナイメージレジストリのセットアップを行います。<br />
OCIでは、Oracle Container Image Registry(OCIR)を利用します。</p>

<p class="notice--info"><strong>OCIRについて</strong><br />
フルマネージドなDocker v2標準対応のコンテナレジストリを提供するサービスです。OKEと同一リージョンに展開することによる低レイテンシを実現します。  詳細は<a href="https://www.oracle.com/jp/cloud-native/container-registry/">こちら</a>のページをご確認ください。</p>

<p>左上のハンバーガーメニューをクリックして、「開発者サービス」-「コンテナ・レジストリ」を選択します。</p>

<p><img src="1-3-001.png" alt="" /></p>

<p>「リポジトリの作成」ボタンをクリックします。</p>

<p><img src="1-3-002.png" alt="" /></p>

<p>「リポジトリ名」に「frontend-app-apm」と入力、「アクセス」で「パブリック」を選択して、「リポジトリの作成」ボタンをクリックします。</p>

<p><img src="1-3-003.png" alt="" /></p>

<p class="notice--warning"><strong>レポジトリ名について</strong><br />
OCIRのレポジトリ名はテナンシで一意になります。<br />
集合ハンズオンなど複数人で同一環境を共有されている皆様は、<code class="language-plaintext highlighter-rouge">frontend-app-apm01</code>や<code class="language-plaintext highlighter-rouge">frontend-app-apm-tn</code>などの名前のイニシャルを付与し、名前が重複しないようにしてください。</p>

<p>OCIRにコンテナイメージをプッシュする際に必要となる、「Username」と「Password」を取得します。</p>

<p>「Username」は、<code class="language-plaintext highlighter-rouge">&lt;オブジェクト・ストレージ・ネームスペース&gt;/&lt;ユーザ名&gt;</code> となります。</p>

<p>＜ユーザ名＞を確認します。ユーザ名は右上にある「プロファイル」アイコンをクリックして、プロファイル名を選択します。</p>

<p><img src="1-3-004.png" alt="" /></p>

<p>「ユーザーの詳細画面」の赤枠箇所をコピーして、テキストエディタにペーストしておきます。</p>

<p><img src="1-3-005.png" alt="" /></p>

<p>次に、＜オブジェクト・ストレージ・ネームスペース＞を確認します。</p>

<p>右上にある「プロファイル」アイコンをクリックして、「テナンシ」を選択します。</p>

<p><img src="1-3-006.png" alt="" /></p>

<p>「テナンシ詳細」の「名前」と「オブジェクト・ストレージ・ネームスペース」の赤枠箇所をコピーして、テキストエディタにペーストしておきます。</p>

<p>※「テナンシ詳細」の「名前」は、「テナンシ名」となり、後続手順で必要となります。</p>

<p><img src="1-3-007.png" alt="" /></p>

<p>次に、「Password」となる認証トークンを設定します。</p>

<p>右上にある「プロファイル」アイコンをクリックして、プロファイル名を選択します。</p>

<p><img src="1-3-008.png" alt="" /></p>

<p>左メニュー「認証トークン」を選択します。</p>

<p><img src="1-3-009.png" alt="" /></p>

<p>「トークンの作成」をボタンをクリックします。</p>

<p><img src="1-3-010.png" alt="" /></p>

<p>「説明」に「oke-handson-apm」と入力して、「トークンの生成」ボタンをクリックします。</p>

<p><img src="1-3-011.png" alt="" /></p>

<p>「コピー」をクリックして、「閉じる」ボタンをクリックします。  コピーした認証トークンは、後の手順で必要となるので、テキストエディタなどにペーストしておきます。</p>

<p><img src="1-3-012.png" alt="" /></p>

<p>以上で、認証トークンの作成は完了です。</p>

<p>以下、テキストエディタにペーストした内容に当てはめて利用します。</p>

<p>「Username」：<code class="language-plaintext highlighter-rouge">&lt;オブジェクト・ストレージ・ネームスペース&gt;/&lt;ユーザ名&gt;</code></p>

<p>「Password」： <code class="language-plaintext highlighter-rouge">認証トークン</code> を利用します。</p>

<p>以上でOCIRのセットアップは完了です。</p>

<h2 id="2application-performance-monitoring">2.Application Performance Monitoring</h2>

<h3 id="2-1-サンプルアプリケーションの概要説明">2-1. サンプルアプリケーションの概要説明</h3>

<p>まずはホームディレクトリに移動し、以下のGitレポジトリをcloneします。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/oracle-japan/code-at-customer-handson
</code></pre></div></div>

<p>このハンズオン用に作成したサンプルアプリケーションです。<br />
中身を簡単に紹介します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">.</span>
├── README.md
├── k8s <span class="o">==&gt;</span> KubernetesのMainifest群
├── olympic_backend_amp <span class="o">==&gt;</span> バックエンドアプリケーション
├── olympic_datasource_amp <span class="o">==&gt;</span> データソースアプリケーション
├── olympic_frontend_amp <span class="o">==&gt;</span> フロントエンドアプリケーション
<span class="nb">.</span>
</code></pre></div></div>

<p>このサンプルアプリケーションは、主に以下の2つから構成されています。</p>

<ul>
  <li><a href="https://oracle-japan-oss-docs.github.io/helidon/docs/v2/#/about/01_overview">Helidon</a>
    <ul>
      <li>Oracleがオープンソースで提供しているJavaのマイクロサービスフレームワーク</li>
    </ul>
  </li>
  <li><a href="https://www.oracle.com/jp/application-development/technologies/jet/oracle-jet.html">Oracle JavaScript Extension Toolkit（Oracle JET）</a>
    <ul>
      <li>Oracleがオープンソースで開発しているJavascript用フレームワーク</li>
      <li>業界標準として普及しているオープンソース・フレームワークに基づき、開発者がより優れたアプリケーションをより迅速に構築できるよう支援する高度な機能とサービスを付加</li>
    </ul>
  </li>
</ul>

<p>簡単にアプリケーションの構成を見ていきます。<br />
この手順が完了すると全体のイメージは以下のようになります。</p>

<p><img src="2-1-001.png" alt="" /></p>

<p>Oracle Cloud Infrastructureの構成としては以下のような図になります。</p>

<p><img src="2-1-002.png" alt="" /></p>

<p>このサンプルアプリケーションは、3つのコンポーネントから以下のように構成されています。</p>

<ul class="notice--info">
  <li>
    <p>フロントエンドアプリケーション(図中の<code class="language-plaintext highlighter-rouge">Olympics</code>)<br />
HelidonとOracle JETから構成されているアプリケーションです。<br />
Helidonの静的コンテンツルート(今回は<code class="language-plaintext highlighter-rouge">resources/web配下</code>)にOracle JETのコンテンツを配置しています。<br />
このアプリケーションは、バックエンドサービス(v1/v2/v3)のいずれかを呼び出します。</p>
  </li>
  <li>
    <p>バックエンドアプリケーション(図中の緑枠部分)<br />
Helidonから構成されているアプリケーションです。
このアプリケーションには3つのバージョンが存在し、それぞれ金メダメリスト(v3)、銀メダリスト(v2)、銅メダリスト(v1)の一覧を返すようになっています。 
バージョン情報は環境変数として保持しています。
このアプリケーションは、データソースアプリケーションに対してバージョンに応じたAPIエンドポイントを呼び出し、データを取得しにいきます。</p>
  </li>
  <li>
    <p>データソースアプリケーション(図中の<code class="language-plaintext highlighter-rouge">Medal Info</code>)<br />
Helidonとインメモリで動作しているデータベースである<a href="https://www.h2database.com/html/main.html">H2 Database</a>から構成されているアプリケーションです。<br />
このアプリケーションでは、メダリストと獲得したメダルの色を保持しており、バックエンドアプリケーションから呼び出されたエンドポイント応じてメダリストとそのメダルの色を返却します。</p>

    <p><strong>Helidonについて</strong><br />
Helidonは<code class="language-plaintext highlighter-rouge">Maven</code>を利用してプロジェクトの雛形を作成することができます。<br />
コマンドについては<a href="https://helidon.io/docs/v2/#/mp/guides/02_quickstart">こちら</a>をご確認ください。<br />
この中にはデフォルトでDockerfileも含まれています。<br />
以降で利用するDockerfileも、基本的に上記雛形ファイルを利用しています。
また、HelidonにはHelidon CLIという便利なCLIツールがあります。<br />
Helidon CLIについては<a href="https://oracle-japan.github.io/ocitutorials/cloud-native/helidon-mp-for-beginners/">こちら</a>をご確認ください。</p>
  </li>
</ul>

<h3 id="2-2-サンプルアプリケーションとapm連携設定">2-2 サンプルアプリケーションとAPM連携設定</h3>

<p>クローンしたサンプルアプリケーションにAPMと連携するための設定を行います。</p>

<p class="notice--info"><strong>本手順について</strong><br />
この手順2-2は、トライアル環境や管理者権限をお持ちの環境でハンズオンを実施されている皆様には不要な手順ですので、スキップしていただき、手順2-3から実施してください。</p>

<p>まずは、OCI APMを利用するためのポリシーを作成してきます。</p>

<p>OCIコンソールのハンバーガーメニューを開き、「アイデンティティとセキュリティ」から「ポリシー」を選択します。</p>

<p><img src="2-2-001.png" alt="" /></p>

<p>「ポリシーの作成」をクリックします。</p>

<p><img src="2-2-002.png" alt="" /></p>

<p>以下の情報を入力します。<br />
また、「手動エディタの表示」にチェックを入れます。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>名前</td>
      <td>apm_policy</td>
    </tr>
    <tr>
      <td>説明</td>
      <td>apm_policy</td>
    </tr>
    <tr>
      <td>コンパートメント</td>
      <td>ご自身のコンパートメント名</td>
    </tr>
    <tr>
      <td>ポリシー</td>
      <td><code class="language-plaintext highlighter-rouge">Allow group APM-Admins to manage apm-domains in compartment id &lt;ご自身のコンパートメントOCID&gt;</code></td>
    </tr>
  </tbody>
</table>

<p><img src="2-2-003.png" alt="" /></p>

<p>画像はイメージですので、コンパートメントOCIDはご自身の環境に合わせて読み替えてください。</p>

<p>「作成」をクリックします。</p>

<p>これで、ポリシーの設定は完了です。</p>

<h3 id="2-3-apmドメインの作成">2-3 APMドメインの作成</h3>

<p>ここでは、APMドメインの作成を行います。</p>

<p>OCIコンソールのハンバーガーメニューを開き、「監視および管理」から「アプリケーション・パフォーマンス・モニタリング」カテゴリの「管理」を選択します。</p>

<p><img src="2-3-001.png" alt="" /></p>

<p>「APMドメインの作成」をクリックします。</p>

<p><img src="2-3-002.png" alt="" /></p>

<p>以下の情報を入力します。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>名前</td>
      <td>oke-handson-apm</td>
    </tr>
    <tr>
      <td>説明</td>
      <td>oke-handson-apm</td>
    </tr>
  </tbody>
</table>

<p class="notice--info"><strong>集合ハンズオンで参加されている皆様へ</strong><br />
APMドメイン名は重複が許容されないため、集合ハンズオンなどで同一環境を複数名でご利用されている皆様はAPMドメイン名に自分のイニシャルや好きな複数桁の番号などを付与し、重複しないようにAPMドメイン名を設定してください。</p>

<p>「作成」をクリックします。</p>

<p><img src="2-3-003.png" alt="" /></p>

<p>ドメインが「作成中」のステータスになるので、「アクティブ」になるまで待機します。</p>

<p><img src="2-3-004.png" alt="" /></p>

<p>ドメインが「アクティブ」になったら、ドメイン名の箇所をクリックします。</p>

<p>以下、「APMドメイン情報」をコピーし、エディタなどに記録しておきます。</p>

<ul>
  <li>「データ・アップロード・エンドポイント」</li>
  <li>「データ・キー」の「プライベート」キー</li>
  <li>「パブリック」キーの値</li>
</ul>

<p>この値は、アプリケーション側からトレーシング情報をAPMにアップロードする際のエンドポイントとその際に利用するキーになり、後ほど利用します。</p>

<p><img src="2-3-005.png" alt="" />
<img src="2-3-006.png" alt="" /></p>

<p>これで、APMドメインの作成は完了です。</p>

<h3 id="2-4-サンプルアプリケーションのビルドとコンテナイメージシップ">2-4 サンプルアプリケーションのビルドとコンテナイメージシップ</h3>

<p>サンプルアプリケーションのフロントエンドアプリケーションにAPMのエンドポイントとパブリックキーを設定します。</p>

<p>この設定を行うことで、フロントエンドアプリケーションからのトレース情報をAPM側で取得できるようになります。<br />
その後、ビルドしてコンテナイメージを作成します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim code-at-customer-handson/olympic_frontend_apm/src/main/resources/web/index.html
</code></pre></div></div>

<p><strong><em>コマンド結果</em></strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~~~
    &lt;script&gt;
      window.apmrum = (window.apmrum || {}); 
      window.apmrum.serviceName='oke-helidon-demo-frontend-UI';
      window.apmrum.webApplication='OracleJetApp';
      window.apmrum.ociDataUploadEndpoint='https://xxxxxxxxxxxxxxx.apm-agt.us-ashburn-1.oci.oraclecloud.com';　#変更箇所1
      window.apmrum.OracleAPMPublicDataKey='&lt;your-public-data-key&gt;';　#変更箇所2
      window.apmrum.traceSupportingEndpoints =  [
        { headers: [ 'APM' ], hostPattern: '.*' },
      ]; 
    &lt;/script&gt;
    &lt;script async crossorigin="anonymous" src="https://xxxxxxxxxxxxxxx.apm-agt.us-ashburn-1.oci.oraclecloud.com/static/jslib/apmrum.min.js"&gt;&lt;/script&gt; #変更箇所3
~~~
</code></pre></div></div>

<p>#変更箇所1「window.apmrum.ociDataUploadEndpoint」には、<a href="#2-3-apmドメインの作成">2-3 APMドメインの作成</a>で記録した「データ・アップロード・エンドポイント」を設定します。</p>

<p>#変更箇所2「window.apmrum.OracleAPMPublicDataKey」には、<a href="#2-3-apmドメインの作成">2-3 APMドメインの作成</a>で記録した「データ・キー」のパブリックキーを設定します。<br />
※プライベートキーではなく、パブリックキーとなるので注意してください。</p>

<p>#変更箇所3 staticより前の部分「https～.com」までを<a href="#2-3-apmドメインの作成">2-3 APMドメインの作成</a>で記録した「データ・アップロード・エンドポイント」を設定します。</p>

<p>更新後、「:wq」エディタを保存終了します。</p>

<p>ディレクトリを移動後、ビルドしてコンテナイメージを作成します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>code-at-customer-handson/olympic_frontend_apm
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">your-object-storage-namespace</code> は、事前に取得したオブジェクト・ストレージ・ネームスペースを指定します。</p>

<p>※リージョンが、アッシュバーン(us-ashburn-1)ではない場合、環境に合わせて「iad.ocir.io」の部分も変更してください。<br />
※コンテナレジストリのリポジトリ名は、事前にご自身で設定した名前に合わせてください。</p>

<p>各リージョンのOCIRエンドポイントは<a href="https://docs.oracle.com/ja-jp/iaas/Content/Registry/Concepts/registryprerequisites.htm">こちら</a>で確認できます。<br />
ここでは、以降も「iad.ocir.io」で進めます。</p>

<p>数分後に Successfully の表示がされればビルドは成功です。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker image build <span class="nt">-t</span> iad.ocir.io/&lt;your-object-storage-namespace&gt;/frontend-app-apm <span class="nb">.</span>
</code></pre></div></div>

<p><strong><em>コマンド結果</em></strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~~~
Successfully built b3bd22ffd681
Successfully tagged iad.ocir.io/&lt;your-object-storage-namespace&gt;/frontend-app-apm:latest
</code></pre></div></div>

<p>OCIRにログインします。「iad.ocir.io」エンドポイントについては、ビルド時と同様、環境に合わせてください。</p>

<p>「Username」と「Password」は、事前に確認した以下を入力します。</p>

<p>「Username」：<code class="language-plaintext highlighter-rouge">&lt;オブジェクト・ストレージ・ネームスペース&gt;/&lt;ユーザ名&gt;</code></p>

<p>「Password」： <code class="language-plaintext highlighter-rouge">認証トークン</code> を利用します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker login iad.ocir.io
</code></pre></div></div>

<p><strong><em>コマンド結果</em></strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Username: &lt;オブジェクト・ストレージ・ネームスペース&gt;/&lt;ユーザ名&gt;
Password: 認証トークン
WARNING! Your password will be stored unencrypted <span class="k">in</span> /home/xxxxx/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store

Login Succeeded
</code></pre></div></div>

<p>作成したコンテナイメージをプッシュします。  <code class="language-plaintext highlighter-rouge">your-object-storage-namespace</code> は、事前に取得したオブジェクト・ストレージ・ネームスペースを指定します。リポジトリ名は、事前にご自身で設定した名前に合わせてください。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker image push iad.ocir.io/&lt;your-object-storage-namespace&gt;/frontend-app-apm
</code></pre></div></div>

<p><strong><em>コマンド結果</em></strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The push refers to repository <span class="o">[</span>iad.ocir.io/&lt;your-object-storage-namespace&gt;/frontend-app-apm]
129b7b03d44d: Pushed 
ee383522dea8: Pushed 
aa321ebc98e2: Pushed 
492be60e6c97: Pushed 
20f064be7fc0: Pushed 
7da834c1ebd3: Pushed 
7d0ebbe3f5d2: Pushed 
latest: digest: sha256:5e52a9d52d52b18a58ec71972db95980b43dcfe9fc78c7a83502b76c50d971d5 size: 1789
</code></pre></div></div>

<p>以上で、サンプルアプリケーションのビルドとコンテナイメージシップは完了です。</p>

<h3 id="2-5-サンプルアプリケーションのmanifest設定の変更">2-5 サンプルアプリケーションのManifest設定の変更</h3>

<p>ここでは、Manifestの設定を変更していきます。</p>

<p>Manifestのあるディレクトリに移動します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>code-at-customer-handson/k8s/app/for-oci-apm-v2
</code></pre></div></div>

<p>フロントエンドアプリケーションのManifestをvimで開きます。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim olympic_frontend.yaml
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">frontend-app</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">frontend-app</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">frontend-app</span>
      <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">frontend-app</span>
        <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">frontend-app</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">iad.ocir.io/&lt;your-object-storage-namespace&gt;/frontend-app-apm</span> <span class="c1">#変更箇所</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8082</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">tracing.data-upload-endpoint</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">https://xxxxxxxxxxxxxxxx.apm-agt.us-ashburn-1.oci.oraclecloud.com</span> <span class="c1">#変更箇所</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">tracing.private-data-key</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">XXXXXXXXXXXXXXXXXXXXXXXX</span> <span class="c1">#変更箇所</span>
<span class="s">~~~</span>
</code></pre></div></div>

<p>「iad.ocir.io/＜your-object-storage-namespace＞/frontend-app-apm」をご自身の環境に合わせて変更します。</p>

<p>25行目から29行目の<code class="language-plaintext highlighter-rouge">env</code>フィールドの<code class="language-plaintext highlighter-rouge">tracing.data-upload-endpoint</code>、<code class="language-plaintext highlighter-rouge">tracing.private-data-key</code>の<code class="language-plaintext highlighter-rouge">value</code>を<a href="#2-3-apmドメインの作成">2-3 APMドメインの作成</a>で記録したAPMドメインとプライベート・データキーに差し替えます。</p>

<p>以下のようになります。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">~~~</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">frontend-app</span>
      <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">frontend-app</span>
        <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">frontend-app</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">iad.ocir.io/&lt;your-object-storage-namespace&gt;/frontend-app-apm</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8082</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">tracing.data-upload-endpoint</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">&lt;ご自身のAPMドメインのエンドポイント&gt;</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">tracing.private-data-key</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">&lt;ご自身のAPMドメインのプライベート・データキー&gt;</span>
</code></pre></div></div>

<p>この状態で保存します。</p>

<p>バックエンド、データソースアプリケーションにも実施します。<br />
※コンテナレジストリの箇所は変更不要、APMドメインのエンドポイントとAPMドメインのプライベート・データキーのみとなります。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim olympic_backend.yaml
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">backend-app-v1</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">backend-app</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">2</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">backend-app</span>
      <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">backend-app</span>
        <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">backend-app</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">nrt.ocir.io/orasejapan/codeatcustomer/backend-app-v1-apm</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8081</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">tracing.data-upload-endpoint</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">https://xxxxxxxxxxxxxxxx.apm-agt.us-ashburn-1.oci.oraclecloud.com</span> <span class="c1">#変更箇所</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">tracing.private-data-key</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">XXXXXXXXXXXXXXXXXXXXXXXX</span> <span class="c1">#変更箇所</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">backend-app-v2</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">backend-app</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">v2</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">2</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">backend-app</span>
      <span class="na">version</span><span class="pi">:</span> <span class="s">v2</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">backend-app</span>
        <span class="na">version</span><span class="pi">:</span> <span class="s">v2</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">backend-app</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">nrt.ocir.io/orasejapan/codeatcustomer/backend-app-v2-apm</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8081</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">tracing.data-upload-endpoint</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">https://xxxxxxxxxxxxxxxx.apm-agt.us-ashburn-1.oci.oraclecloud.com</span> <span class="c1">#変更箇所</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">tracing.private-data-key</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">XXXXXXXXXXXXXXXXXXXXXXXX</span> <span class="c1">#変更箇所</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">backend-app-v3</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">backend-app</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">v3</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">2</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">backend-app</span>
      <span class="na">version</span><span class="pi">:</span> <span class="s">v3</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">backend-app</span>
        <span class="na">version</span><span class="pi">:</span> <span class="s">v3</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">backend-app</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">nrt.ocir.io/orasejapan/codeatcustomer/backend-app-v3-apm</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8081</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">tracing.data-upload-endpoint</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">https://xxxxxxxxxxxxxxxx.apm-agt.us-ashburn-1.oci.oraclecloud.com</span> <span class="c1">#変更箇所</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">tracing.private-data-key</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">XXXXXXXXXXXXXXXXXXXXXXXX</span> <span class="c1">#変更箇所</span>
</code></pre></div></div>

<p>25行目から29行目、55行目から59行目、85行目から89行目の<code class="language-plaintext highlighter-rouge">env</code>フィールドの<code class="language-plaintext highlighter-rouge">tracing.data-upload-endpoint</code>、<code class="language-plaintext highlighter-rouge">tracing.private-data-key</code>の<code class="language-plaintext highlighter-rouge">value</code>を<a href="#6-2-apmドメインの作成">6-2 APMドメインの作成</a>で記録したAPMドメインとプライベート・データキーにそれぞれ差し替えます。</p>

<p>以下のようになります。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">backend-app-v1</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">backend-app</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">2</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">backend-app</span>
      <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">backend-app</span>
        <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">backend-app</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">nrt.ocir.io/orasejapan/codeatcustomer/backend-app-v1-apm</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8081</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">tracing.data-upload-endpoint</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">&lt;ご自身のAPMドメインのエンドポイント&gt;</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">tracing.private-data-key</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">&lt;ご自身のAPMドメインのプライベート・データキー&gt;</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">backend-app-v2</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">backend-app</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">v2</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">2</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">backend-app</span>
      <span class="na">version</span><span class="pi">:</span> <span class="s">v2</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">backend-app</span>
        <span class="na">version</span><span class="pi">:</span> <span class="s">v2</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">backend-app</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">nrt.ocir.io/orasejapan/codeatcustomer/backend-app-v2-apm</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8081</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">tracing.data-upload-endpoint</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">&lt;ご自身のAPMドメインのエンドポイント&gt;</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">tracing.private-data-key</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">&lt;ご自身のAPMドメインのプライベート・データキー&gt;</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">backend-app-v3</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">backend-app</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">v3</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">2</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">backend-app</span>
      <span class="na">version</span><span class="pi">:</span> <span class="s">v3</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">backend-app</span>
        <span class="na">version</span><span class="pi">:</span> <span class="s">v3</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">backend-app</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">nrt.ocir.io/orasejapan/codeatcustomer/backend-app-v3-apm</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8081</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">tracing.data-upload-endpoint</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">&lt;ご自身のAPMドメインのエンドポイント&gt;</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">tracing.private-data-key</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">&lt;ご自身のAPMドメインのプライベート・データキー&gt;</span>
</code></pre></div></div>

<p>最後にデータソースアプリケーションに対しても実施します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim olympic_datasource.yaml
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">datasource-app</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">datasource-app</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">2</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">datasource-app</span>
      <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">datasource-app</span>
        <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">datasource-app</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">nrt.ocir.io/orasejapan/codeatcustomer/datasource-app-apm</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8080</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">tracing.data-upload-endpoint</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">https://xxxxxxxxxxxxxxxx.apm-agt.us-ashburn-1.oci.oraclecloud.com</span> <span class="c1">#変更箇所</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">tracing.private-data-key</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">XXXXXXXXXXXXXXXXXXXXXXXX</span> <span class="c1">#変更箇所</span>
</code></pre></div></div>

<p>25行目から29行目の<code class="language-plaintext highlighter-rouge">env</code>フィールドの<code class="language-plaintext highlighter-rouge">tracing.data-upload-endpoint</code>、<code class="language-plaintext highlighter-rouge">tracing.private-data-key</code>の<code class="language-plaintext highlighter-rouge">value</code>を<a href="#6-2-apmドメインの作成">6-2 APMドメインの作成</a>で記録したAPMドメインとプライベート・データキーに差し替えます。</p>

<p>以下のようになります。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">datasource-app</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">datasource-app</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">2</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">datasource-app</span>
      <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">datasource-app</span>
        <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">datasource-app</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">nrt.ocir.io/orasejapan/codeatcustomer/datasource-app-apm</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8080</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">tracing.data-upload-endpoint</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">&lt;ご自身のAPMドメインのエンドポイント&gt;</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">tracing.private-data-key</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">&lt;ご自身のAPMドメインのプライベート・データキー&gt;</span>
</code></pre></div></div>

<p>これでサンプルアプリケーションのManifest設定の変更は完了です。</p>

<p>ここで利用するコンテナアプリケーションは、OCI APMを利用するためにアプリケーション側にトレーシングの設定を入れています。<br />
今回、OCI APMで利用しているアプリケーションは、code-at-customer-handsonディレクトリ配下の<code class="language-plaintext highlighter-rouge">_apm</code>が付与されているプロジェクトになります。</p>

<div class="notice--info">
  <p><strong>HelidonアプリケーションでのOCI APMの利用</strong><br />
今回はHelidonを利用したアプリケーションですが、<a href="https://docs.oracle.com/ja-jp/iaas/application-performance-monitoring/doc/use-apm-tracer-helidon.html">HelidonにはOCI APM専用のエージェント</a>が用意されています。<br />
基本的には、<code class="language-plaintext highlighter-rouge">pom.xml</code>に以下の依存関係を追加するだけで利用可能です。(アプリケーション側の変更は必要ありません)<br />
また、必要に応じて<code class="language-plaintext highlighter-rouge">src/main/resources/META-INF/microprofile-config.properties</code>に設定値を追加します。</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.oracle.apm.agent.java<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>apm-java-agent-helidon<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>RELEASE<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.oracle.apm.agent.java<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>apm-java-agent-tracer<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>RELEASE<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>

    <span class="nt">&lt;repositories&gt;</span>
        <span class="nt">&lt;repository&gt;</span>
            <span class="nt">&lt;id&gt;</span>oci<span class="nt">&lt;/id&gt;</span>
            <span class="nt">&lt;name&gt;</span>OCI Object Store<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;url&gt;</span>https://objectstorage.us-ashburn-1.oraclecloud.com/n/idhph4hmky92/b/prod-agent-binaries/o<span class="nt">&lt;/url&gt;</span>
        <span class="nt">&lt;/repository&gt;</span>
    <span class="nt">&lt;/repositories&gt;</span>
</code></pre></div></div>

<p>今回、<code class="language-plaintext highlighter-rouge">microprofile-config.properties</code>については以下のように設定しています。(フロントエンドアプリケーションの場合)</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1"># OCI APM関連</span>
  <span class="s">tracing.enabled=true</span>
  <span class="s">tracing.service=oke-helidon-demo-frontend-service</span>
  <span class="s">tracing.name="frontend-helidon-service"</span>
</code></pre></div></div>


</div>

<p class="notice--info"><strong>既存ZipkinプラットフォームでのOCI APMの利用</strong><br />
OCI APMはZipkin互換にもなっているので、既存のZipkinベースのAPMプラットフォームをOCI APMで利用して頂くことも可能です。<br />
詳細については<a href="https://docs.oracle.com/ja-jp/iaas/application-performance-monitoring/doc/configure-open-source-tracing-systems.html">こちら</a>をご確認ください。</p>

<h3 id="2-6-oci-apmでのトレーシング">2-6 OCI APMでのトレーシング</h3>

<p>いよいよ、OCI APMを利用したトレーシングを実施します。</p>

<p>再度、サンプルアプリケーションをデプロイします。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>code-at-customer-handson/k8s/app/for-oci-apm-v2
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> <span class="nb">.</span> 
</code></pre></div></div>

<p><strong><em>コマンド結果</em></strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>deployment.apps/backend-app-v1 created
deployment.apps/backend-app-v2 created
deployment.apps/backend-app-v3 created
service/backend-app created
deployment.apps/datasource-app created
service/datasource-app created
deployment.apps/frontend-app created
service/frontend-app created
</code></pre></div></div>

<p>アプリケーションにアクセスします。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get service frontend-app
</code></pre></div></div>

<p><strong><em>コマンド結果</em></strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME           TYPE           CLUSTER-IP      EXTERNAL-IP    PORT<span class="o">(</span>S<span class="o">)</span>        AGE
frontend-app   LoadBalancer   10.96.220.188   193.122.xxx.xxx   80:31664/TCP   41s
</code></pre></div></div>

<p>上記の場合は、frontend-app Serviceの<code class="language-plaintext highlighter-rouge">EXTERNAL-IP</code>である<code class="language-plaintext highlighter-rouge">193.122.xxx.xxx</code>がエンドポイントになります。</p>

<p>この場合は、以下のURLにアクセスします。<br />
<code class="language-plaintext highlighter-rouge">http://193.122.xxx.xxxx</code></p>

<p><img src="2-6-008.png" alt="" /></p>

<p>何度かアクセスしたのちに、トレース情報をOCI APMから確認します。</p>

<p>OCIコンソールのハンバーガーメニューを開き、「監視および管理」から「アプリケーション・パフォーマンス・モニタリング」カテゴリの「トレース・エクスプローラー」を選択します。</p>

<p><img src="2-6-001.png" alt="" /></p>

<p>画面上部にある「APMドメイン」から、<a href="#6-2-apmドメインの作成">6-2 APMドメインの作成</a>で作成したAPMドメインを選択します。</p>

<p><img src="2-6-002.png" alt="" /></p>

<p>右側にある検索条件を「過去15分間」に選択し、「実行」ボタンをクリックします。</p>

<p><img src="2-6-003.png" alt="" /></p>

<p>複数のトレース情報が表示されますので、「完了」と表示され、<code class="language-plaintext highlighter-rouge">Spans</code>が26となっている情報をクリックします。</p>

<p><img src="2-6-004.png" alt="" /></p>

<p>以下のような詳細なトレース情報を取得できます。</p>

<p><img src="2-6-005.png" alt="" />
<img src="2-6-006.png" alt="" /></p>

<p>赤枠の「oke-helidon-demo-frontend-UI: Ajax /medalist」をクリックすると、詳細なクライアント情報を取得できます。</p>

<p><img src="2-6-007.png" alt="" /></p>

<p>終了する場合は、「閉じる」ボタンをクリックします。</p>

<p>以上で、OCI APMを利用したトレーシングは完了です。</p>

<h3 id="2-7-oci-apmでのアプリケーションサーバのメトリクス監視">2-7 OCI APMでのアプリケーションサーバのメトリクス監視</h3>

<p>ここでは、OCI APMで監視できるアプリケーションサーバのメトリクスについて見ていきたいと思います。</p>

<p>画面左上のプルダウンから「ダッシュボード」をクリックします。</p>

<p><img src="2-7-001.png" alt="" /></p>

<p>ダッシュボードから「アプリケーション・サーバー」をクリックします。</p>

<p><img src="2-7-002.png" alt="" /></p>

<p>左上に「アプリケーションサーバを選択します」というプルダウンがあるので、任意のアプリケーションサーバ(実体はHelidonのPod)を選択します。</p>

<p><img src="2-7-003.png" alt="" /></p>

<p>アプリケーションサーバ(今回はHelidon)のメトリクス情報が表示されます。</p>

<p><img src="2-7-004.png" alt="" /></p>

<p>ここで取得したメトリクスをもとに、OCI MonitoringやOCI Notificationsと連携すると、一定の閾値を超過した際にアラーム通知を行うこともできます。</p>

<p class="notice--info"><strong>OCI MonitoringとOCI Notificationsについて</strong><br />
OCIにはリソース監視を行うOCI Monitoringがあり、OCI Notificationsと連携するとEmailやSlackなどに対してアラーム通知を行うことができます。<br />
詳細は<a href="/ocitutorials/intermediates/monitoring-resources/">こちら</a>のハンズオンをご確認ください。</p>

<p>OCI APMを利用すると詳細なトレーシングの取得と確認およびアプリケーションサーバのメトリクス監視を行うことができます。</p>

<h2 id="3logging">3.Logging</h2>

<p>Oracle Cloud Infrastructure（OCI）Loggingサービスは、スタック全体からのログの取り込み、管理および分析を簡素化する、完全に管理されたクラウドネイティブの分散ロギング・プラットフォームです。インフラストラクチャ、アプリケーション、監査、およびデータベースのログが1つのビューで管理できます。</p>

<p>実際に、構築したOKEクラスタ内のワーカー・ノードのコンピュート・インスタンスで実行されているアプリケーションのログを表示および検索します。</p>

<h3 id="3-1-カスタムログの設定">3-1 カスタム・ログの設定</h3>

<p>OCI Loggingサービスを使用する上で必要となるポリシーを設定します。</p>

<h4 id="動的グループの作成">動的グループの作成</h4>

<p>テナントのOICDが必要となるので取得します。</p>

<p>右上にある「プロファイル」アイコンをクリックして、「テナンシ」を選択します。</p>

<p><img src="1-3-006.png" alt="" /></p>

<p>「OICD」の「コピー」テキストをクリックして、テキストエディタにペーストしておきます。</p>

<p><img src="3-1-015.png" alt="" /></p>

<p>左上のハンバーガーメニューを展開して、「アイデンティティとセキュリティ」から「動的グループ」を選択します。</p>

<p><img src="3-1-012.png" alt="" /></p>

<p>「動的グループの作成」ボタンをクリックします。</p>

<p><img src="3-1-013.png" alt="" /></p>

<p>以下を設定します。</p>

<ul>
  <li>名前：logging-dynamic-group</li>
  <li>説明：logging-dynamic-group</li>
</ul>

<p>ルールについては以下を設定します。＜your-OCID＞ は事前に取得したOCIDを設定します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>instance.compartment.id <span class="o">=</span> <span class="s1">'&lt;your-OCID&gt;'</span>
</code></pre></div></div>

<p><img src="3-1-014.png" alt="" /></p>

<h4 id="ポリシー設定">ポリシー設定</h4>

<p>左上のハンバーガーメニューを展開して、「アイデンティティとセキュリティ」から「ポリシー」を選択します。</p>

<p><img src="3-1-001.png" alt="" /></p>

<p>「ポリシーの作成」ボタンをクリックします。</p>

<p><img src="3-1-002.png" alt="" /></p>

<p>以下を設定します。</p>

<p>「名前」：logging
「説明」：logging</p>

<p>「手動エディタの表示」ボタンを右にスライドします。</p>

<p>以下のポリシーを設定します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>allow dynamic-group logging-dynamic-group to use log-content <span class="k">in </span>tenancy
</code></pre></div></div>

<p><img src="3-1-003.png" alt="" /></p>

<p>「作成」ボタンをクリックします。</p>

<p><img src="3-1-004.png" alt="" /></p>

<p>以上で、ポリシーの設定は完了です。</p>

<h4 id="カスタムログ設定">カスタム・ログ設定</h4>

<p>次に、カスタム・ログ設定をします。<br />
左上のハンバーガーメニューを展開して、「監視および管理」から「ログ」を選択します。</p>

<p><img src="3-1-005.png" alt="" /></p>

<p>「カスタム・ログの作成」ボタンをクリックします。</p>

<p><img src="3-1-006.png" alt="" /></p>

<p>「カスタム・ログ名」に「worker-node」と入力して、「新規グループの作成」をクリックします。</p>

<p><img src="3-1-007.png" alt="" /></p>

<p>「名前」に「handson_log」と入力します。</p>

<p><img src="3-1-011.png" alt="" /></p>

<p>「作成」ボタンをクリックします。</p>

<p><img src="3-1-004.png" alt="" /></p>

<p>「カスタム・ログの作成」ボタンをクリックします。</p>

<p><img src="3-1-008.png" alt="" /></p>

<p>「エージェント構成の作成」において、以下を設定します。</p>

<ul>
  <li>「構成名」：worker-node</li>
  <li>「説明」：worker-node</li>
  <li>「グループ・タイプ」：動的グループ</li>
  <li>「グループ」：logging-dynamic-group</li>
  <li>「入力タイプ」：ログ・パス</li>
  <li>「名前の入力」：oke_cluster</li>
  <li>「ファイル・パス」：/var/log/containers/*</li>
</ul>

<p><img src="3-1-009.png" alt="" /></p>

<p>「カスタム・ログの作成」ボタンをクリックします。</p>

<p><img src="3-1-008.png" alt="" /></p>

<p>リストに「woker-node」と表示されていることを確認します。</p>

<p><img src="3-1-010.png" alt="" /></p>

<h3 id="3-2-ワーカーノード上のアプリケーションログの確認">3-2 ワーカーノード上のアプリケーションログの確認</h3>

<p>設定した「woker-node」を選択して、ログを確認します。</p>

<p>「worker-node」をクリックします。</p>

<p><img src="3-2-001.png" alt="" /></p>

<p>以下のようにワーカーノード上のPod（コンテナ）から出力されるログが表示されます。</p>

<p>※設定してからログを取得するまで時間を要する場合があります。</p>

<p><img src="3-2-002.png" alt="" /></p>

<h3 id="3-3-kubernetes-apiサーバーの監査ログの確認">3-3 Kubernetes APIサーバーの監査ログの確認</h3>

<p>クラスタで発生するアクティビティの背後にあるコンテキストを理解することは、多くの場合有用です。たとえば、誰がいつ何をしたかを識別することによって、コンプライアンス・チェックを実行したり、セキュリティの異常を識別したり、エラーをトラブルシューティングします。</p>

<p>OCIのAuditサービスを利用することで、以下の監査イベントを取得できます。</p>

<ul>
  <li>OKEにおける作成や削除などのアクションをクラスタで実行するたびに監査イベントを発行します。</li>
  <li>Kubernetes APIサーバーにおけるkubectlなどのツールを使用してサービスの作成などの管理上の変更をクラスタに加えるたびに監査イベントを発行します。</li>
</ul>

<p>OKEで実行された操作のログを確認します。</p>

<p>左上のハンバーガーメニューを展開して、「アイデンティティとセキュリティ」から「監査」を選択します。</p>

<p><img src="3-3-001.png" alt="" /></p>

<p>「キーワード」に「ClustersAPI」と入力して、「検索」ボタンをクリックします。</p>

<p><img src="3-3-002.png" alt="" /></p>

<p>以下のように表示されます。</p>

<p><img src="3-3-003.png" alt="" /></p>

<p>次に、Kubernetes APIサーバーによって実行された操作のログを確認します。</p>

<p>「キーワード」に「OKE API Server Admin Access」と入力して、「検索」ボタンをクリックします。</p>

<p><img src="3-3-004.png" alt="" /></p>

<p>以下のように表示されます。</p>

<p><img src="3-3-005.png" alt="" /></p>

<p>以上で、Kubernetes APIサーバーの監査ログの確認は完了です。</p>

<ol>
  <li>
    <h2 id="monitoring--notifications">Monitoring &amp; Notifications</h2>
  </li>
</ol>

<p>OCI NotificationsとMonitoringを組み合わせて、閾値を超えるとアラートが上がり、メール通知する仕組みを構築します。</p>

<h3 id="4-1-notificationsの設定">4-1 Notificationsの設定</h3>

<p>左上のハンバーガーメニューをクリックして、「開発者サービス」-「通知」を選択します。</p>

<p><img src="4-1-001.png" alt="" /></p>

<p>「トピックの作成」ボタンをクリックします。</p>

<p><img src="4-1-002.png" alt="" /></p>

<p class="notice--warning"><strong>トピックの名前について</strong><br />
トピックの名前はテナンシで一意になります。<br />
集合ハンズオンなど複数人で同一環境を共有されている皆様は、<code class="language-plaintext highlighter-rouge">oci-devops-handson-01</code>や<code class="language-plaintext highlighter-rouge">handson-tn</code>などの名前のイニシャルを付与し、名前が重複しないようにしてください。</p>

<p>「名前」に「oci-notifications」と入力します。</p>

<p><img src="4-1-003.png" alt="" /></p>

<p>「作成」ボタンをクリックします。</p>

<p><img src="4-1-004.png" alt="" /></p>

<p>「アクティブ」になることを確認します。</p>

<p><img src="4-1-005.png" alt="" /></p>

<p>以上でトピックの作成は完了です。</p>

<p>次に、サブスクリプションを作成します。</p>

<p>左メニュー「サブスクリプション」を選択します。</p>

<p><img src="4-1-006.png" alt="" /></p>

<p>「サブスクリプションの作成」ボタンをクリックします。</p>

<p><img src="4-1-007.png" alt="" /></p>

<p>「電子メール」にご自身のメールアドレスを入力します。</p>

<p><img src="4-1-008.png" alt="" /></p>

<p>「作成」ボタンをクリックします。</p>

<p><img src="4-1-009.png" alt="" /></p>

<p>設定したメールアドレスに、以下の内容のメールが届きます。「Confirm subscription」をクリックして、サブスクリプションを有効にします。</p>

<p><img src="4-1-010.png" alt="" /></p>

<p><img src="4-1-011.png" alt="" /></p>

<p>アクティブになっていることを確認します。<br />
アクティブになっていない場合は、ブラウザを更新してください。</p>

<p><img src="4-1-012.png" alt="" /></p>

<p>以上で、サブスクリプションの作成は完了です。</p>

<h3 id="4-2-monitoringの設定">4-2 Monitoringの設定</h3>

<p>後続手順で、サンプルアプリケーションに負荷をかけて、ヒープサイズを上げます。OCI Monitoringで閾値を設定して、その閾値を超えるとアラームが上がり、Notificationsに設定したメールアドレスに通知されるように設定を行います。</p>

<p>左上のハンバーガーメニューをクリックして、「監視および管理」-「アラーム定義」を選択します。</p>

<p><img src="4-2-001.png" alt="" /></p>

<p>「アラームの作成」ボタンをクリックします。</p>

<p><img src="4-2-002.png" alt="" /></p>

<p>「アラームの定義」で以下を設定してます。</p>

<ul>
  <li>「アラーム名」：heap-size</li>
  <li>「メトリック・ネームスペース」：oracle_apm_monitoring</li>
  <li>「メトリック名」：HeapUsed</li>
  <li>「統計」：Max</li>
  <li>「ディメンション名」：OkeClusterld</li>
  <li>「ディメンション値」：表示されるClusterIDを選択</li>
  <li>「値」：600000000</li>
  <li>「トピック」：oci-notifications</li>
</ul>

<p><img src="4-2-003.png" alt="" /></p>

<p><img src="4-2-004.png" alt="" /></p>

<p>「アラームの保存」ボタンをクリックします。</p>

<p><img src="4-2-005.png" alt="" /></p>

<p>以上で、「アラーム定義」の設定は完了です。</p>

<h3 id="4-3-monitoringとnotificationsの実践">4-3 MonitoringとNotificationsの実践</h3>

<p>サンプルアプリケーションに対して、過剰なアクセス負荷をかけます。そして、アラーム発生後にメールが通知されるように設定を行います。</p>

<p>最初に、負荷をかけるサーバを構築します。Jmeterという負荷テスト用のアプリケーションを利用して環境をセットアップします。</p>

<h4 id="jmeterサーバの構築">jmeterサーバの構築</h4>

<p>左上のハンバーガーメニューをクリックして、「コンピュート」-「インスタンス」を選択します。</p>

<p><img src="4-3-001.png" alt="" /></p>

<p>「インスタンスの作成」ボタンをクリックします。</p>

<p><img src="4-3-002.png" alt="" /></p>

<p>「名前」に「jmeter」と入力します。</p>

<p><img src="4-3-003.png" alt="" /></p>

<p>次に、「イメージとシェイプ」の「編集」をクリックします。</p>

<p><img src="4-3-004.png" alt="" /></p>

<p>「Shape」の「Change Shape」ボタンをクリックします。</p>

<p><img src="4-3-030.png" alt="" /></p>

<p>以下の内容に設定をします。</p>

<ul>
  <li>「シェイプ・シリーズ」：AMD</li>
  <li>「Shape Name」：VM.Standard.E4.Flex</li>
  <li>「OCPUの数」：2</li>
  <li>「メモリー量(GB)」：32</li>
</ul>

<p><img src="4-3-005.png" alt="" /></p>

<p>「シェイプの選択」ボタンをクリックします。</p>

<p><img src="4-3-006.png" alt="" /></p>

<p>「ネットワーキング」で「編集」をクリックします。</p>

<p><img src="4-3-031.png" alt="" /></p>

<p>「ネットワーキング」で「新規仮想クラウド・ネットワークの作成」を選択します。</p>

<p><img src="4-3-007.png" alt="" /></p>

<p>「SSHキーの追加」で「秘密キーの保存」ボタンをクリックして、秘密鍵をダウンロードします。</p>

<p><img src="4-3-008.png" alt="" /></p>

<p>「作成」ボタンをクリックします。</p>

<p><img src="4-3-009.png" alt="" /></p>

<p>ログイン時に必要となる「パブリックIPアドレス」と「ユーザ名」を確認します。<br />
※テキストエディタにコピーペーストしておきます。</p>

<p><img src="4-3-017.png" alt="" /></p>

<h4 id="jmeter環境のセットアップ">jmeter環境のセットアップ</h4>

<p>jmeter環境をセットアップするために、作成した仮想マシンにログインします。</p>

<p>Cloud Shell アイコンをクリックした、Cloud Shellを起動します。</p>

<p><img src="4-3-010.png" alt="" /></p>

<p><img src="4-3-011.png" alt="" /></p>

<p>最初に、ダウンロードした秘密鍵をCloud Shell上にアップロードします。</p>

<p>「Cloud Shell」メニューをクリックします。</p>

<p><img src="4-3-012.png" alt="" /></p>

<p>「アップロード」を選択します。</p>

<p><img src="4-3-013.png" alt="" /></p>

<p>「コンピュータから選択」をクリックして、ダウンロードした秘密鍵を選択します。</p>

<p><img src="4-3-014.png" alt="" /></p>

<p>「アップロード」ボタンをクリックします。</p>

<p><img src="4-3-015.png" alt="" /></p>

<p>「非表示」をクリックします。</p>

<p><img src="4-3-016.png" alt="" /></p>

<p>ホームディレクトリに移動します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~
</code></pre></div></div>

<p>秘密鍵のパーミッションを変更します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">chmod </span>400 ssh-key-xxxx-xx-xx.key
</code></pre></div></div>

<p>仮想マシンにログインします。事前に確認したユーザ名とパブリックIPアドレスを利用します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh <span class="nt">-i</span> ssh-key-xxxx-xx-xx.key opc@xxx.xxx.xxx.xxx
</code></pre></div></div>

<p>yes と入力します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FIPS mode initialized
The authenticity of host <span class="s1">'132.226.236.71 (132.226.236.71)'</span> can<span class="s1">'t be established.
ECDSA key fingerprint is SHA256:oACNnKKWu3R9WUi3xpYVnunWcIoEF8NL5LztfUqlZ74.
ECDSA key fingerprint is SHA1:z2sVFWORAMBlpeuUgHx5Ou4X1Cg.
Are you sure you want to continue connecting (yes/no)? yes
</span></code></pre></div></div>

<p>rootユーザにスイッチします。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> <span class="nt">-i</span>
</code></pre></div></div>

<p>java-openjdk をインストールします。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum <span class="nb">install</span> <span class="nt">-y</span> java-1.8.0-openjdk
</code></pre></div></div>

<p><strong><em>コマンド結果</em></strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~~~
Complete!
</code></pre></div></div>

<p>Jmeterをダウンロードします。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://ftp.jaist.ac.jp/pub/apache/jmeter/binaries/apache-jmeter-5.4.3.tgz
</code></pre></div></div>

<p><strong><em>コマンド結果</em></strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">--2022-02-07</span> 08:33:34--  https://ftp.jaist.ac.jp/pub/apache/jmeter/binaries/apache-jmeter-5.4.3.tgz
Resolving ftp.jaist.ac.jp <span class="o">(</span>ftp.jaist.ac.jp<span class="o">)</span>... 150.65.7.130, 2001:df0:2ed:feed::feed
Connecting to ftp.jaist.ac.jp <span class="o">(</span>ftp.jaist.ac.jp<span class="o">)</span>|150.65.7.130|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 70796171 <span class="o">(</span>68M<span class="o">)</span> <span class="o">[</span>application/x-gzip]
Saving to: ‘apache-jmeter-5.4.3.tgz’

100%[<span class="o">=======================================================================================&gt;]</span> 70,796,171  5.71MB/s   <span class="k">in </span>12s    

2022-02-07 08:33:47 <span class="o">(</span>5.49 MB/s<span class="o">)</span> - ‘apache-jmeter-5.4.3.tgz’ saved <span class="o">[</span>70796171/70796171]
</code></pre></div></div>

<p>アーカイブを展開します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">tar</span> <span class="nt">-zxvf</span> apache-jmeter-5.4.3.tgz
</code></pre></div></div>

<p>作業ディレクトリを作成します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>test_work
</code></pre></div></div>
<p>「test_work」ディレクトリに移動します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>test_work
</code></pre></div></div>

<p>Jmeterのプロファイルを作成します。「xxx.xxx.xxx.xxx」は、事前に確認したサンプルアプリケーションのエンドポイントに書き換えます。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim testplan.jmx
</code></pre></div></div>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">"1.0"</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">"UTF-8"</span>?&gt;
&lt;jmeterTestPlan <span class="nv">version</span><span class="o">=</span><span class="s2">"1.2"</span> <span class="nv">properties</span><span class="o">=</span><span class="s2">"5.0"</span> <span class="nv">jmeter</span><span class="o">=</span><span class="s2">"5.4.3"</span><span class="o">&gt;</span>
  &lt;hashTree&gt;
    &lt;TestPlan <span class="nv">guiclass</span><span class="o">=</span><span class="s2">"TestPlanGui"</span> <span class="nv">testclass</span><span class="o">=</span><span class="s2">"TestPlan"</span> <span class="nv">testname</span><span class="o">=</span><span class="s2">"Test Plan"</span> <span class="nv">enabled</span><span class="o">=</span><span class="s2">"true"</span><span class="o">&gt;</span>
      &lt;stringProp <span class="nv">name</span><span class="o">=</span><span class="s2">"TestPlan.comments"</span><span class="o">&gt;</span>&lt;/stringProp&gt;
      &lt;boolProp <span class="nv">name</span><span class="o">=</span><span class="s2">"TestPlan.functional_mode"</span><span class="o">&gt;</span><span class="nb">false</span>&lt;/boolProp&gt;
      &lt;boolProp <span class="nv">name</span><span class="o">=</span><span class="s2">"TestPlan.tearDown_on_shutdown"</span><span class="o">&gt;</span><span class="nb">true</span>&lt;/boolProp&gt;
      &lt;boolProp <span class="nv">name</span><span class="o">=</span><span class="s2">"TestPlan.serialize_threadgroups"</span><span class="o">&gt;</span><span class="nb">false</span>&lt;/boolProp&gt;
      &lt;elementProp <span class="nv">name</span><span class="o">=</span><span class="s2">"TestPlan.user_defined_variables"</span> <span class="nv">elementType</span><span class="o">=</span><span class="s2">"Arguments"</span> <span class="nv">guiclass</span><span class="o">=</span><span class="s2">"ArgumentsPanel"</span> <span class="nv">testclass</span><span class="o">=</span><span class="s2">"Arguments"</span> <span class="nv">testname</span><span class="o">=</span><span class="s2">"User Defined Variables"</span> <span class="nv">enabled</span><span class="o">=</span><span class="s2">"true"</span><span class="o">&gt;</span>
        &lt;collectionProp <span class="nv">name</span><span class="o">=</span><span class="s2">"Arguments.arguments"</span>/&gt;
      &lt;/elementProp&gt;
      &lt;stringProp <span class="nv">name</span><span class="o">=</span><span class="s2">"TestPlan.user_define_classpath"</span><span class="o">&gt;</span>&lt;/stringProp&gt;
    &lt;/TestPlan&gt;
    &lt;hashTree&gt;
      &lt;ThreadGroup <span class="nv">guiclass</span><span class="o">=</span><span class="s2">"ThreadGroupGui"</span> <span class="nv">testclass</span><span class="o">=</span><span class="s2">"ThreadGroup"</span> <span class="nv">testname</span><span class="o">=</span><span class="s2">"Thread Group"</span> <span class="nv">enabled</span><span class="o">=</span><span class="s2">"true"</span><span class="o">&gt;</span>
        &lt;stringProp <span class="nv">name</span><span class="o">=</span><span class="s2">"ThreadGroup.on_sample_error"</span><span class="o">&gt;</span><span class="k">continue</span>&lt;/stringProp&gt;
        &lt;elementProp <span class="nv">name</span><span class="o">=</span><span class="s2">"ThreadGroup.main_controller"</span> <span class="nv">elementType</span><span class="o">=</span><span class="s2">"LoopController"</span> <span class="nv">guiclass</span><span class="o">=</span><span class="s2">"LoopControlPanel"</span> <span class="nv">testclass</span><span class="o">=</span><span class="s2">"LoopController"</span> <span class="nv">testname</span><span class="o">=</span><span class="s2">"Loop Controller"</span> <span class="nv">enabled</span><span class="o">=</span><span class="s2">"true"</span><span class="o">&gt;</span>
          &lt;boolProp <span class="nv">name</span><span class="o">=</span><span class="s2">"LoopController.continue_forever"</span><span class="o">&gt;</span><span class="nb">false</span>&lt;/boolProp&gt;
          &lt;intProp <span class="nv">name</span><span class="o">=</span><span class="s2">"LoopController.loops"</span><span class="o">&gt;</span><span class="nt">-1</span>&lt;/intProp&gt;
        &lt;/elementProp&gt;
        &lt;stringProp <span class="nv">name</span><span class="o">=</span><span class="s2">"ThreadGroup.num_threads"</span><span class="o">&gt;</span>80000&lt;/stringProp&gt;
        &lt;stringProp <span class="nv">name</span><span class="o">=</span><span class="s2">"ThreadGroup.ramp_time"</span><span class="o">&gt;</span>60&lt;/stringProp&gt;
        &lt;boolProp <span class="nv">name</span><span class="o">=</span><span class="s2">"ThreadGroup.scheduler"</span><span class="o">&gt;</span><span class="nb">false</span>&lt;/boolProp&gt;
        &lt;stringProp <span class="nv">name</span><span class="o">=</span><span class="s2">"ThreadGroup.duration"</span><span class="o">&gt;</span>&lt;/stringProp&gt;
        &lt;stringProp <span class="nv">name</span><span class="o">=</span><span class="s2">"ThreadGroup.delay"</span><span class="o">&gt;</span>&lt;/stringProp&gt;
        &lt;boolProp <span class="nv">name</span><span class="o">=</span><span class="s2">"ThreadGroup.same_user_on_next_iteration"</span><span class="o">&gt;</span><span class="nb">true</span>&lt;/boolProp&gt;
      &lt;/ThreadGroup&gt;
      &lt;hashTree&gt;
        &lt;HTTPSamplerProxy <span class="nv">guiclass</span><span class="o">=</span><span class="s2">"HttpTestSampleGui"</span> <span class="nv">testclass</span><span class="o">=</span><span class="s2">"HTTPSamplerProxy"</span> <span class="nv">testname</span><span class="o">=</span><span class="s2">"HTTP Request"</span> <span class="nv">enabled</span><span class="o">=</span><span class="s2">"true"</span><span class="o">&gt;</span>
          &lt;elementProp <span class="nv">name</span><span class="o">=</span><span class="s2">"HTTPsampler.Arguments"</span> <span class="nv">elementType</span><span class="o">=</span><span class="s2">"Arguments"</span> <span class="nv">guiclass</span><span class="o">=</span><span class="s2">"HTTPArgumentsPanel"</span> <span class="nv">testclass</span><span class="o">=</span><span class="s2">"Arguments"</span> <span class="nv">testname</span><span class="o">=</span><span class="s2">"User Defined Variables"</span> <span class="nv">enabled</span><span class="o">=</span><span class="s2">"true"</span><span class="o">&gt;</span>
            &lt;collectionProp <span class="nv">name</span><span class="o">=</span><span class="s2">"Arguments.arguments"</span>/&gt;
          &lt;/elementProp&gt;
          &lt;stringProp <span class="nv">name</span><span class="o">=</span><span class="s2">"HTTPSampler.domain"</span><span class="o">&gt;</span>xxx.xxx.xxx.xxx&lt;/stringProp&gt;
          &lt;stringProp <span class="nv">name</span><span class="o">=</span><span class="s2">"HTTPSampler.port"</span><span class="o">&gt;</span>&lt;/stringProp&gt;
          &lt;stringProp <span class="nv">name</span><span class="o">=</span><span class="s2">"HTTPSampler.protocol"</span><span class="o">&gt;</span>http&lt;/stringProp&gt;
          &lt;stringProp <span class="nv">name</span><span class="o">=</span><span class="s2">"HTTPSampler.contentEncoding"</span><span class="o">&gt;</span>&lt;/stringProp&gt;
          &lt;stringProp <span class="nv">name</span><span class="o">=</span><span class="s2">"HTTPSampler.path"</span><span class="o">&gt;</span>/medalist&lt;/stringProp&gt;
          &lt;stringProp <span class="nv">name</span><span class="o">=</span><span class="s2">"HTTPSampler.method"</span><span class="o">&gt;</span>GET&lt;/stringProp&gt;
          &lt;boolProp <span class="nv">name</span><span class="o">=</span><span class="s2">"HTTPSampler.follow_redirects"</span><span class="o">&gt;</span><span class="nb">true</span>&lt;/boolProp&gt;
          &lt;boolProp <span class="nv">name</span><span class="o">=</span><span class="s2">"HTTPSampler.auto_redirects"</span><span class="o">&gt;</span><span class="nb">false</span>&lt;/boolProp&gt;
          &lt;boolProp <span class="nv">name</span><span class="o">=</span><span class="s2">"HTTPSampler.use_keepalive"</span><span class="o">&gt;</span><span class="nb">true</span>&lt;/boolProp&gt;
          &lt;boolProp <span class="nv">name</span><span class="o">=</span><span class="s2">"HTTPSampler.DO_MULTIPART_POST"</span><span class="o">&gt;</span><span class="nb">false</span>&lt;/boolProp&gt;
          &lt;stringProp <span class="nv">name</span><span class="o">=</span><span class="s2">"HTTPSampler.embedded_url_re"</span><span class="o">&gt;</span>&lt;/stringProp&gt;
          &lt;stringProp <span class="nv">name</span><span class="o">=</span><span class="s2">"HTTPSampler.connect_timeout"</span><span class="o">&gt;</span>&lt;/stringProp&gt;
          &lt;stringProp <span class="nv">name</span><span class="o">=</span><span class="s2">"HTTPSampler.response_timeout"</span><span class="o">&gt;</span>&lt;/stringProp&gt;
        &lt;/HTTPSamplerProxy&gt;
        &lt;hashTree/&gt;
      &lt;/hashTree&gt;
    &lt;/hashTree&gt;
  &lt;/hashTree&gt;
&lt;/jmeterTestPlan&gt;

</code></pre></div></div>

<p>負荷をかけます。止める場合は、「Ctrl + C」で停止できます。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">JVM_ARGS</span><span class="o">=</span><span class="s2">"-Xms12G -Xmx12G"</span>  ../apache-jmeter-5.4.3/bin/jmeter <span class="nt">-n</span> <span class="nt">-t</span> ./testplan.jmx <span class="nt">-l</span> ./testplan.jtl <span class="nt">-e</span> <span class="nt">-o</span> html_repo_testplan
</code></pre></div></div>

<p>途中でエラーで停止する場合は、以下コマンドで「testplan.jtl」ファイルを削除して、負荷をかけなおしてください。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">rm</span> <span class="nt">-rf</span> testplan.jtl
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">JVM_ARGS</span><span class="o">=</span><span class="s2">"-Xms12G -Xmx12G"</span>  ../apache-jmeter-5.4.3/bin/jmeter <span class="nt">-n</span> <span class="nt">-t</span> ./testplan.jmx <span class="nt">-l</span> ./testplan.jtl <span class="nt">-e</span> <span class="nt">-o</span> html_repo_testplan
</code></pre></div></div>

<h4 id="状況の確認">状況の確認</h4>

<p>負荷の状況を確認します。</p>

<p>左上のハンバーガーメニューをクリックして、「監視および管理」-「アラーム定義」を選択します。</p>

<p><img src="4-3-018.png" alt="" /></p>

<p>「heap-size」をクリックします。</p>

<p><img src="4-3-019.png" alt="" /></p>

<p>赤い破線が設定した閾値となります。この閾値を超えるとアラームが上がって、メールで通知されます。</p>

<p><img src="4-3-020.png" alt="" /></p>

<p><img src="4-3-032.png" alt="" /></p>

<p>アラームと通知を停止する場合は、「アラームは有効です」のチェックを外します。</p>

<p><img src="4-3-021.png" alt="" /></p>

<p>APMからも状況を確認します。</p>

<p>左上のハンバーガーメニューをクリックして、「監視および管理」-「ダッシュボード」を選択します。</p>

<p><img src="4-3-022.png" alt="" /></p>

<p>「アプリケーション・サーバー」をクリックします。</p>

<p><img src="4-3-023.png" alt="" /></p>

<p>APMドメインのプルダウンメニューから「oke-handson-apm」を選択します。</p>

<p><img src="4-3-024.png" alt="" /></p>

<p>対象となるPod名「frontend-app-xxxxxxxxxx-xxxxx」を確認します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods
</code></pre></div></div>

<p><strong><em>コマンド結果</em></strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME                              READY   STATUS    RESTARTS   AGE
・
・
・
frontend-app-56f7cfcb74-gpqh8     1/1     Running   0          23h
</code></pre></div></div>

<p>プルダウンメニューから確認した対象のPodを選択します。</p>

<p><img src="4-3-025.png" alt="" /></p>

<p>デフォルトでは、「過去60分間」の状況を確認できます。負荷をかけることで「ヒープ使用状況」の数値があがります。「ヒープ使用状況」では、時系列で状況を確認できます。</p>

<p><img src="4-3-026.png" alt="" /></p>

<p>右上にあるプルダウンメニューから過去の時間で確認できます。「カスタム」を選択すると、任意の時間を設定できます。</p>

<p><img src="4-3-027.png" alt="" /></p>

<p>設定する場合は、時間を指定後、「OK」ボタンをクリックします。</p>

<p><img src="4-3-028.png" alt="" /></p>

<p>通知としては、以下のメールが届きます。</p>

<p><img src="4-3-029.png" alt="" /></p>

<p>以上となります。</p>

        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> 更新日時:</strong> <time datetime="2022-02-22T11:00:06+09:00">February 22, 2022</time></p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">共有</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Oracle+Container+Engine+for+Kubernetes%28OKE%29%E3%81%A7%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%83%9E%E3%82%A4%E3%82%AF%E3%83%AD%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%97%E3%81%A6OCI%E3%81%AE%E3%82%AA%E3%83%96%E3%82%B6%E3%83%90%E3%83%93%E3%83%AA%E3%83%86%E3%82%A3%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6%E3%81%BF%E3%82%88%E3%81%86%20https%3A%2F%2Foracle-japan.github.io%2Focitutorials%2Fcloud-native%2Foke-observability-for-advances%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="共有 Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Foracle-japan.github.io%2Focitutorials%2Fcloud-native%2Foke-observability-for-advances%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="共有 Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Foracle-japan.github.io%2Focitutorials%2Fcloud-native%2Foke-observability-for-advances%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="共有 LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/ocitutorials/cloud-native/oke-for-advances/" class="pagination--pager" title="Oracle Container Engine for Kubernetes(OKE)でサンプルマイクロサービスアプリケーションをデプロイしてオブザバビリティツールを利用してみよう
">前へ</a>
    
    
      <a href="/ocitutorials/cloud-native/fn-for-beginners/" class="pagination--pager" title="Fn Project ハンズオン
">次へ</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">関連記事</h4>
      <div class="grid__wrapper">
        
      </div>
    </div>
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="検索キーワードを入力してください..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>フォロー</strong></li>
    

    
      
        
          <li><a href="https://twitter.com/#ocijp" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/oracle-japan" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
    

    
      <li><a href="/ocitutorials/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2022 Oracle Cloud Infrastructure チュートリアル. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/ocitutorials/assets/js/main.min.js"></script>




<script src="/ocitutorials/assets/js/lunr/lunr.min.js"></script>
<script src="/ocitutorials/assets/js/lunr/lunr-store.js"></script>
<script src="/ocitutorials/assets/js/lunr/lunr-en.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6W7FEC5CEH"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6W7FEC5CEH', { 'anonymize_ip': false});
</script>







  
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
  
    <script src="/ocitutorials/assets/js/clipboardrouge.js"></script>
  



  </body>
</html>
