<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="ja" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>KubernetesでサンプルアプリケーションのデプロイとCI/CDを体験してみよう | Oracle Cloud Infrastructure チュートリアル</title>
<meta name="description" content="OKEを使ってサンプルアプリケーションのデプロイおよびCI/CDを体験していただけるコンテンツです。OKEだけではなく、マネージドなCI/CDサービスであるOCI DevOpsや運用が全て自動化された自律型データベースであるAutonomous Databaseも利用する豊富なコンテンツになっています。">


  <meta name="author" content="Oracle Japan Solution Engineers">
  
  <meta property="article:author" content="Oracle Japan Solution Engineers">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="ja_JP">
<meta property="og:site_name" content="Oracle Cloud Infrastructure チュートリアル">
<meta property="og:title" content="KubernetesでサンプルアプリケーションのデプロイとCI/CDを体験してみよう">
<meta property="og:url" content="https://oracle-japan.github.io/ocitutorials/cloud-native-test/oke-for-intermediates/">


  <meta property="og:description" content="OKEを使ってサンプルアプリケーションのデプロイおよびCI/CDを体験していただけるコンテンツです。OKEだけではなく、マネージドなCI/CDサービスであるOCI DevOpsや運用が全て自動化された自律型データベースであるAutonomous Databaseも利用する豊富なコンテンツになっています。">



  <meta property="og:image" content="https://oracle-japan.github.io/ocitutorials/assets/images/rh01-cloud-home-pine-background.jpg">





  <meta property="article:published_time" content="2021-11-26T10:15:54+09:00">






<link rel="canonical" href="https://oracle-japan.github.io/ocitutorials/cloud-native-test/oke-for-intermediates/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "https://oracle-japan.github.io/ocitutorials/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/ocitutorials/feed.xml" type="application/atom+xml" rel="alternate" title="Oracle Cloud Infrastructure チュートリアル Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/ocitutorials/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/ocitutorials/"><img src="/ocitutorials/assets/images/social-og-oracle-badge.jpg" alt="OCI チュートリアル"></a>
        
        <a class="site-title" href="/ocitutorials/">
          OCI チュートリアル
          <span class="site-subtitle">Oracle Cloud Infrastructure を使ってみよう</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/ocitutorials/beginners/" title="OCIをはじめて使う人のための基本的なチュートリアル">入門編</a>
            </li><li class="masthead__menu-item">
              <a href="/ocitutorials/intermediates/" title="OCIをもっと活用するためのチュートリアル">応用編</a>
            </li><li class="masthead__menu-item">
              <a href="/ocitutorials/database/" title="Oracle Databaseをクラウドで使うためのチュートリアル">Oracle DB編</a>
            </li><li class="masthead__menu-item">
              <a href="/ocitutorials/cloud-native/" title="OCIで Cloud Nativeなアプリケーション開発を行うためのチュートリアル">Cloud Native編</a>
            </li><li class="masthead__menu-item">
              <a href="/ocitutorials/content-management/" title="OCIのコンテンツ管理サービスを使う人のためのチュートリアル">コンテンツ管理編</a>
            </li><li class="masthead__menu-item">
              <a href="/ocitutorials/blockchain/" title="OCIのコンテンツ管理サービスを使う人のためのチュートリアル">ブロックチェーン編</a>
            </li><li class="masthead__menu-item">
              <a href="/ocitutorials/enterprise/" title="エンタープライズなアプリケーションを構築、運用するためのチュートリアル">エンタープライズ編</a>
            </li><li class="masthead__menu-item">
              <a href="/ocitutorials/integration/" title="OICのチュートリアル">インテグレーション編</a>
            </li><li class="masthead__menu-item">
              <a href="/ocitutorials/datascience/" title="OCIのデータサイエンス/ビッグデータ関連サービスのチュートリアル">データサイエンス/ビッグデータ編</a>
            </li><li class="masthead__menu-item">
              <a href="/ocitutorials/about/">このサイトについて</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">メニュー</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      
  







<div class="page__hero--overlay"
  style=" background-image: url('/ocitutorials/assets/images/rh01-cloud-home-pine-background.jpg');"
>
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline">
        
          KubernetesでサンプルアプリケーションのデプロイとCI/CDを体験してみよう

        
      </h1>
      
        <p class="page__lead">OKEを使ってサンプルアプリケーションのデプロイおよびCI/CDを体験していただけるコンテンツです。OKEだけではなく、マネージドなCI/CDサービスであるOCI DevOpsや運用が全て自動化された自律型データベースであるAutonomous Databaseも利用する豊富なコンテンツになっています。
</p>
      
      


      
      
    </div>
  
  
</div>




  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="https://oracle-japan.github.io/ocitutorials/" itemprop="item"><span itemprop="name">ホーム</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">></span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/ocitutorials/cloud-native-test" itemprop="item"><span itemprop="name">Cloud native test</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">></span>
      
    
      
      
        <li class="current">KubernetesでサンプルアプリケーションのデプロイとCI/CDを体験してみよう</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="KubernetesでサンプルアプリケーションのデプロイとCI/CDを体験してみよう">
    <meta itemprop="description" content="OKEを使ってサンプルアプリケーションのデプロイおよびCI/CDを体験していただけるコンテンツです。OKEだけではなく、マネージドなCI/CDサービスであるOCI DevOpsや運用が全て自動化された自律型データベースであるAutonomous Databaseも利用する豊富なコンテンツになっています。">
    <meta itemprop="datePublished" content="2021-11-26T10:15:54+09:00">
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> 目次</h4></header>
              <ul class="toc__menu"><li><a href="#前提条件">前提条件</a></li><li><a href="#ゴールを確認する">ゴールを確認する</a></li><li><a href="#0事前準備">0.事前準備</a><ul><li><a href="#0-1-ハンズオン資材の取得">0-1. ハンズオン資材の取得</a></li><li><a href="#0-2-認証トークンの作成">0-2. 認証トークンの作成</a></li><li><a href="#0-3-オブジェクトストレージネームスペースの確認">0-3. オブジェクト・ストレージ・ネームスペースの確認</a></li><li><a href="#0-4-ocirのレポジトリ作成">0-4. OCIRのレポジトリ作成</a></li></ul></li><li><a href="#1ポリシー作成">1.ポリシー作成</a></li><li><a href="#2oci-devopsのセットアップ">2.OCI DevOpsのセットアップ</a><ul><li><a href="#2-1-oci-notificationの作成">2-1. OCI Notificationの作成</a></li><li><a href="#2-2-oci-devopsインスタンスの作成">2-2. OCI DevOpsインスタンスの作成</a></li><li><a href="#2-3-サンプルアプリケーションの事前準備">2-3. サンプルアプリケーションの事前準備</a></li></ul></li><li><a href="#3atpのプロビジョニング">3.ATPのプロビジョニング</a><ul><li><a href="#3-1-operator-sdkおよびオペレータライフサイクルマネージャolmのインストール">3-1. Operator SDKおよびオペレータ・ライフサイクル・マネージャ(OLM)のインストール</a></li><li><a href="#3-2-atpのプロビジョニング">3-2. ATPのプロビジョニング</a></li></ul></li><li><a href="#4atpへのサンプルデータ登録">4.ATPへのサンプルデータ登録</a><ul><li><a href="#4-1-サンプルデータの登録">4-1. サンプルデータの登録</a></li><li><a href="#4-2-アプリケーション用のデータベースユーザ名とパスワードの作成">4-2. アプリケーション用のデータベースユーザ名とパスワードの作成</a></li></ul></li><li><a href="#5ciパイプラインの構築">5.CIパイプラインの構築</a><ul><li><a href="#5-1-build_specyamlの確認">5-1. build_spec.yamlの確認</a></li><li><a href="#5-2-ciパイプラインの構築">5-2. CIパイプラインの構築</a></li><li><a href="#5-2-トリガーの作成">5-2. トリガーの作成</a></li></ul></li><li><a href="#6cdパイプラインの構築">6.CDパイプラインの構築</a><ul><li><a href="#6-1-アーティファクトレジストリへのmanifestファイルの登録">6-1. アーティファクト・レジストリへのManifestファイルの登録</a></li><li><a href="#6-2-oci-devopsへのoke環境の登録">6-2. OCI DevOpsへのOKE環境の登録</a></li><li><a href="#6-3-cdパイプラインの構築">6-3. CDパイプラインの構築</a></li><li><a href="#6-4-ciパイプラインへのcdパイプライン起動ステップの追加">6-4. CIパイプラインへのCDパイプライン起動ステップの追加</a></li></ul></li><li><a href="#7アプリケーションのデプロイ">7.アプリケーションのデプロイ</a></li><li><a href="#8アプリケーションの再デプロイ">8.アプリケーションの再デプロイ</a><ul><li><a href="#8-1-アプリケーションのヘッダー画像の変更">8-1. アプリケーションのヘッダー画像の変更</a></li><li><a href="#8-2-アプリケーションの反映確認">8-2. アプリケーションの反映確認</a></li></ul></li><li><a href="#9オプション今回利用したアプリケーションに関する補足">9.【オプション】今回利用したアプリケーションに関する補足</a></li></ul>

            </nav>
          </aside>
        
        <p>このワークショップでは、OCI DevOpsを利用してCI/CDパイプラインをセットアップし、Oracle Autonomous Transaction ProcessingをデータソースとしたJavaアプリケーションをOracle Container Engine for Kubernetes（OKE）にデプロイする一連の流れを体験することができます</p>

<p>このワークショップには以下のサービスが含まれます。</p>

<ul>
  <li>
    <dl>
      <dt><a href="https://www.oracle.com/jp/database/atp-cloud.html">Oracle Autonomous Transaction Processing</a>（略称：ATP）:</dt>
      <dd>運用がすべて自動化された自律型データベースサービスです。</dd>
    </dl>
  </li>
  <li>
    <dl>
      <dt><a href="https://www.oracle.com/jp/cloud/compute/container-engine-kubernetes.html">Oracle Container Engine for Kubernetes</a>（略称：OKE）:</dt>
      <dd>マネージドなKuberentesクラスタを提供するクラウドサービスです。</dd>
    </dl>
  </li>
  <li>
    <dl>
      <dt><a href="https://www.oracle.com/jp/application-development/visual-builder-studio/">Oracle Cloud Infrastructure DevOps</a>（略称：OCI DevOps）:</dt>
      <dd>Oracle Cloudが提供するマネージドなCI/CDサービスです。</dd>
    </dl>
  </li>
  <li>
    <dl>
      <dt><a href="https://www.oracle.com/jp/cloud/compute/container-registry.html">Oracle Cloud Infrastructure Registry</a>（略称：OCIR）:</dt>
      <dd>フルマネージドなDocker v2標準対応のコンテナレジストリを提供するサービスです。</dd>
    </dl>
  </li>
</ul>

<h2 id="前提条件">前提条件</h2>

<p>ワークショップを開始する前に以下を準備してください。</p>

<ul>
  <li>
    <p><a href="https://cloud.oracle.com/ja_JP/tryit">Oracle Cloudのアカウントを取得済みであること</a></p>
  </li>
  <li>
    <p><a href="/ocitutorials/cloud-native/oke-for-commons/">OKEハンズオン事前準備</a>を実施済みであること</p>
  </li>
</ul>

<p>Oracle Cloud Infrastructureの基本操作は<a href="/ocitutorials/beginners/getting-started/">チュートリアル : OCIコンソールにアクセスして基本を理解する</a>をご確認ください。</p>

<h2 id="ゴールを確認する">ゴールを確認する</h2>

<p>はじめに、手順を最後まで実施したときにどのような環境が作られるか確認して、ゴールの全体像を掴んでおきましょう。<br />
手順を最後まで行うと、下図のような環境が構成されます。</p>

<table>
  <thead>
    <tr>
      <th>構成要素</th>
      <th>説明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>OKE Cluster</td>
      <td>アプリケーションのコンテナが稼働するクラスター本体です。OKEをプロビジョニングすると、Oracle Cloudの各種IaaS上に自動的に構成されます。</td>
    </tr>
    <tr>
      <td>OCI DevOps</td>
      <td>OKE Clusterに対してアプリケーションのデプロイ(CI/CD)を実施するサービスです。</td>
    </tr>
    <tr>
      <td>Autonomous Transaction Processing</td>
      <td>今回デプロイするサンプルアプリケーションが利用するデータベースです。</td>
    </tr>
    <tr>
      <td>OCIR</td>
      <td>コンテナイメージを保存するレポジトリです。</td>
    </tr>
  </tbody>
</table>

<h2 id="0事前準備">0.事前準備</h2>

<h3 id="0-1-ハンズオン資材の取得">0-1. ハンズオン資材の取得</h3>
<p>まずは、今回のハンズオンで利用する資材をGitHubから取得します。</p>

<p><a href="/ocitutorials/cloud-native/oke-for-commons/#2cli%E5%AE%9F%E8%A1%8C%E7%92%B0%E5%A2%83cloud-shell%E3%81%AE%E6%BA%96%E5%82%99">Cloud Shellを起動</a>し、git cloneを実行します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/oracle-japan/oke-atp-helidon-handson.git
</code></pre></div></div>

<p>これで資材の取得は完了です。</p>

<h3 id="0-2-認証トークンの作成">0-2. 認証トークンの作成</h3>

<p>ここでは、OCI DevOpsのレポジトリ操作に必要な認証トークンを取得します。</p>

<p>OCIコンソール画面右上の人型のアイコンをクリックし、展開したプロファイルからユーザ名(oracleidentitycloudservice/<ユーザ名>)をクリックします。</ユーザ名></p>

<p><img src="0-001.jpg" alt="0-001.jpg" /></p>

<p>下にスクロールして「リソース」の「認証トークン」に移動し、「トークンの生成」ボタンをクリックします。</p>

<p><img src="0-002.jpg" alt="0-002.jpg" /></p>

<p><img src="0-003.jpg" alt="0-003.jpg" />をクリックします。</p>

<p>以下の項目を入力します。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>説明</td>
      <td>oke handson</td>
    </tr>
  </tbody>
</table>

<p><img src="0-004.jpg" alt="0-004.jpg" /></p>

<p><img src="0-005.jpg" alt="0-005.jpg" />をクリックします。</p>

<p><img src="0-006.jpg" alt="0-006.jpg" /></p>

<p>表示されたトークンをコピーして、エディタなどに記録しておきます。</p>

<p class="notice--warning"><strong>受講者の方へ</strong><br />
生成されたトークンは一回のみ表示されます。<br />
「コピー」をクリックしてトークンがコピーされ、どこに保存してください。完了したら、「閉じる」ボタンをクリックします。（注：忘れたときは作成されたトークンを削除して、再度生成してください。）</p>

<h3 id="0-3-オブジェクトストレージネームスペースの確認">0-3. オブジェクト・ストレージ・ネームスペースの確認</h3>

<p>ここでは、OCIRへコンテナイメージをプッシュする際に必要となるオブジェクト・ストレージ・ネームスペースを確認します。</p>

<p>OCIコンソール画面右上の人型のアイコンをクリックし、テナンシ名をクリックします。</p>

<p><img src="0-007.jpg" alt="0-007.jpg" /></p>

<p>赤枠部分の値をコピーして、エディタなどに保存しておきます。</p>

<p><img src="0-008.jpg" alt="0-008.jpg" /></p>

<p>以上で、オブジェクト・ストレージ・ネームスペースの確認は完了です。</p>

<h3 id="0-4-ocirのレポジトリ作成">0-4. OCIRのレポジトリ作成</h3>

<p>ここでは、ビルドしたコンテナイメージをプッシュするためのレポジトリをOCIRに作成します。</p>

<p>OCIコンソールのハンバーガメニューより、「開発者」メニューの「コンテナ・レジストリ」をクリックします。</p>

<p><img src="0-009.jpg" alt="0-009.jpg" /></p>

<p><img src="0-010.jpg" alt="0-010.jpg" />をクリックします。</p>

<p>以下の項目を入力します。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>リポジトリ名</td>
      <td>handson</td>
    </tr>
    <tr>
      <td>アクセス</td>
      <td><code class="language-plaintext highlighter-rouge">パブリック</code>を選択</td>
    </tr>
  </tbody>
</table>

<p><img src="0-011.jpg" alt="0-011.jpg" /></p>

<p><img src="0-012.jpg" alt="0-012.jpg" />をクリックします。</p>

<p>以上で、事前準備は完了です。</p>

<h2 id="1ポリシー作成">1.ポリシー作成</h2>

<p>ここでは、OCI DevOpsを利用するためのポリシーを作成します。</p>

<p>今回は、ポリシーの作成(動的グループを含む)をシェルスクリプトで簡略化していますが、以下の動的グループとポリシーが設定されます。</p>

<table>
  <thead>
    <tr>
      <th>動的グループ</th>
      <th>ルール</th>
      <th>説明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>OCI_DevOps_Dynamic_Group</td>
      <td>instance.compartment.id = ‘コンパートメントOCID’,resource.compartment.id = ‘コンパートメントOCID’</td>
      <td>コンパートメント内の全てのリソースやインスタンスを含めた動的グループ</td>
    </tr>
  </tbody>
</table>

<p class="notice--info"><strong>コンパートメントについて</strong><br />
Oracle Cloud Infrastrctureにはコンパートメントという考え方があります。<br />
コンパートメントは、クラウド・リソース(インスタンス、仮想クラウド・ネットワーク、ブロック・ボリュームなど)を分類整理する論理的な区画で、この単位でアクセス制御を行うことができます。また、OCIコンソール上に表示されるリソースのフィルタとしても機能します。<br />
コンパートメントの詳細は<a href="https://docs.oracle.com/ja-jp/iaas/Content/Identity/Tasks/managingcompartments.htm">こちら</a>のページをご確認ください。</p>

<p class="notice--info"><strong>動的グループについて</strong><br />
Oracle Cloud Infrastrctureには動的グループという考え方があります。
これを利用すると、ユーザではなく、OCI上のリソースやインスタンスを主体とした操作を実現できます。<br />
動的グループの詳細は<a href="https://docs.oracle.com/ja-jp/iaas/Content/Identity/Tasks/managingdynamicgroups.htm">こちら</a>のページをご確認ください。</p>

<p class="notice--warning"><strong>本ハンズオンでの動的グループについて</strong><br />
今回は、簡易的にハンズオンを実施するために、コンパートメント内の全てのリソースやインスタンスを動的グループとして含める設定を行なっています。<br />
本来は、各サービスのタイプを指定して動的グループを作成することになります。</p>

<table>
  <thead>
    <tr>
      <th>ポリシー</th>
      <th>説明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Allow dynamic-group OCI_DevOps_Dynamic_Group to manage devops-family in compartment id ‘コンパートメントOCID’</td>
      <td>OCI DevOpsが自身が持つ各機能を利用可能にするポリシー</td>
    </tr>
    <tr>
      <td>Allow dynamic-group OCI_DevOps_Dynamic_Group to manage all-artifacts in compartment id ‘コンパートメントOCID’</td>
      <td>OCI DevOpsがOCIRやアーティファクト・レジストリを管理可能とするポリシー</td>
    </tr>
    <tr>
      <td>Allow dynamic-group OCI_DevOps_Dynamic_Group to use ons-topics in compartment id ‘コンパートメントOCID’</td>
      <td>OCI DevOpsがOCI Notificationサービス(後続の手順で作成予定)を利用可能とするポリシー</td>
    </tr>
    <tr>
      <td>Allow dynamic-group OCI_DevOps_Dynamic_Group to manage cluster-family in compartment id ‘コンパートメントOCID’</td>
      <td>OCI DevOpsがOKEを管理するためのポリシー</td>
    </tr>
    <tr>
      <td>Allow dynamic-group OCI_DevOps_Dynamic_Group to manage autonomous-database in compartment id ‘コンパートメントOCID’</td>
      <td>後続の手順で登場するOCI Service Operator for Kubernetes(OSOK)がAutonomous Transaction Processingを管理可能とするポリシー</td>
    </tr>
  </tbody>
</table>

<p class="notice--info"><strong>ポリシーについて</strong><br />
Oracle Cloud Infrastrctureにはポリシーという考え方があります。 
ポリシーを利用すると、ユーザや動的グループがどのリソースやサービスでどのような操作を実行可能にするかを制御することができます。<br />
ポリシーの詳細は<a href="https://docs.oracle.com/ja-jp/iaas/Content/Identity/Concepts/policygetstarted.htm#Getting_Started_with_Policies">こちら</a>のページをご確認ください。</p>

<p class="notice--info"><strong>DevOpsのポリシーについて</strong><br />
DevOpsでは、利用する機能やデプロイ先に応じて、今回設定しているポリシーの他にもいくつか設定可能なポリシーがあります。<br />
また、設定するポリシーによって、操作範囲を限定することも可能です。<br />
詳細は<a href="https://docs.oracle.com/ja-jp/iaas/Content/devops/using/devops_iampolicies.htm">こちら</a>のページをご確認ください。</p>

<p>それでは、上記の動的グループとポリシー設定するためのシェルスクリプトを実行します。</p>

<p>シェルスクリプトは<a href="/ocitutorials/cloud-native/oke-for-intermediates/0資材の取得">0.資材の取得</a>で取得した資材内にあります。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>prepare
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">chmod</span> +x prepare.sh
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./prepare.sh
</code></pre></div></div>

<p>これでポリシー作成は完了です。</p>

<h2 id="2oci-devopsのセットアップ">2.OCI DevOpsのセットアップ</h2>

<p>ここでは、OCI DevOpsのインスタンスの作成とサンプルアプリケーションの準備を行います。</p>

<h3 id="2-1-oci-notificationの作成">2-1. OCI Notificationの作成</h3>

<p>まずは、OCI DevOpsのインスタンス作成に入る前にOCI Notificationの作成を行います。<br />
OCI DevOpsを作成する際にはOCI Notificationが作成してあることが必須になります。</p>

<p class="notice--info"><strong>OCI Notificationについて</strong><br />
OCI Notificationは、安全、高信頼性、低レイテンシおよび永続的にメッセージを配信するためのサービスです。<br />
本ハンズオンでは、電子メールアドレスに対して配信を行いますが、他にもSlack/SMS/PagerDutyなどに通知を行うことができます。  また
詳細は<a href="https://docs.oracle.com/ja-jp/iaas/Content/Notification/Concepts/notificationoverview.htm">こちら</a>のページをご確認ください。</p>

<p>OCIコンソールのハンバーガメニューより、「開発者」メニューの「通知」をクリックします。</p>

<p><img src="2-001.jpg" alt="2-001.jpg" /></p>

<p><img src="2-002.jpg" alt="2-002.jpg" />をクリックします。</p>

<p><img src="2-003.jpg" alt="2-003.jpg" /></p>

<p>以下の項目を入力し、<img src="2-004.jpg" alt="2-004.jpg" />をクリックします。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>名前</td>
      <td>oke-handson</td>
    </tr>
  </tbody>
</table>

<p>作成したOCI Notificationのリンクをクリックします。</p>

<p><img src="2-005.jpg" alt="2-005.jpg" /></p>

<p><img src="2-006.jpg" alt="2-006.jpg" />をクリックします。</p>

<p>以下の項目を入力し、<img src="2-004.jpg" alt="2-004.jpg" />をクリックします。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>電子メールアドレス</td>
      <td>ご自身のメールアドレス</td>
    </tr>
  </tbody>
</table>

<p><img src="2-007.jpg" alt="2-007.jpg" /></p>

<p>サブスクリクションが”Pending”の状態で作成されます。</p>

<p><img src="2-008.jpg" alt="2-008.jpg" /></p>

<p>先ほど入力した電子メールアドレスに以下のようなメールが届いているので、確認してください。</p>

<p><img src="2-009.jpg" alt="2-009.jpg" /></p>

<p>メール内の<img src="2-010.jpg" alt="2-010.jpg" />をクリックします。</p>

<p>以下のような画面が表示されます。</p>

<p><img src="2-011.jpg" alt="2-011.jpg" /></p>

<p>先程のOCI Notificationの画面に戻ると、サブスクリプションの状態が”Active”になっていることが確認できます。</p>

<p><img src="2-012.jpg" alt="2-012.jpg" /></p>

<p>これで、OCI Notificationの作成は完了です。</p>

<h3 id="2-2-oci-devopsインスタンスの作成">2-2. OCI DevOpsインスタンスの作成</h3>

<p>ここでは、OCI DevOpsのインスタンスを作成し、サンプルアプリケーションのレポジトリを作成します。</p>

<p>OCIコンソールのハンバーガメニューより、「開発者」メニューの「DevOps」カテゴリにある「プロジェクト」をクリックします。</p>

<p><img src="2-013.jpg" alt="2-013.jpg" /></p>

<p><img src="2-014.jpg" alt="2-014.jpg" />をクリックします。</p>

<p>以下の項目を入力します。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>プロジェクト名</td>
      <td>oke-handson</td>
    </tr>
  </tbody>
</table>

<p><img src="2-016.jpg" alt="2-016.jpg" /></p>

<p><img src="2-015.jpg" alt="2-015.jpg" />をクリックします。</p>

<p>先ほど作成した”oke-handson”という名前のトピックを選択します。</p>

<p><img src="2-017.jpg" alt="2-017.jpg" /></p>

<p><img src="2-018.jpg" alt="2-018.jpg" />をクリックします。</p>

<p><img src="2-019.jpg" alt="2-019.jpg" /></p>

<p>プロビジョニングが完了したら、<img src="2-020.jpg" alt="2-020.jpg" />をクリックします。</p>

<p>以下をクリックします。</p>

<p><img src="2-021.jpg" alt="2-021.jpg" /></p>

<p>そのまま、<img src="2-022.jpg" alt="2-022.jpg" />をクリックします。</p>

<p>以下のような状態になっていれば、問題ありません。</p>

<p><img src="2-023.jpg" alt="2-023.jpg" /></p>

<p>これで、インスタンスの作成は完了です。</p>

<h3 id="2-3-サンプルアプリケーションの事前準備">2-3. サンプルアプリケーションの事前準備</h3>

<p>次にコード・レポジトリを作成します。</p>

<p>左側にあるメニューから「コード・レポジトリ」を選択します。</p>

<p><img src="2-024.jpg" alt="2-024.jpg" /></p>

<p><img src="2-025.jpg" alt="2-025.jpg" />をクリックします。</p>

<p>以下の項目を入力します。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>リポジトリ名</td>
      <td>oke-handson</td>
    </tr>
  </tbody>
</table>

<p><img src="2-026.jpg" alt="2-026.jpg" /></p>

<p><img src="2-027.jpg" alt="2-027.jpg" />をクリックします。</p>

<p>レポジトリの作成が完了したら、<img src="2-028.jpg" alt="2-028.jpg" />をクリックします。</p>

<p>表示されたダイアログの以下の赤枠部分をクリックし、URLをコピーします。</p>

<p><img src="2-029.jpg" alt="2-029.jpg" /></p>

<p><img src="2-030.jpg" alt="2-030.jpg" />をクリックします。</p>

<p><a href="/ocitutorials/cloud-native/oke-for-commons/#2cli%E5%AE%9F%E8%A1%8C%E7%92%B0%E5%A2%83cloud-shell%E3%81%AE%E6%BA%96%E5%82%99">Cloud Shellを起動</a>します。</p>

<p>先ほどコピーしたURLをgit cloneします。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone &lt;コピーしたURL&gt;
</code></pre></div></div>

<p>cloneする際にユーザ名をパスワードを聞かれます。<br />
それぞれ以下の通りとなります。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
      <th>説明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ユーザ名</td>
      <td>&lt;オブジェクト・ストレージ・ネームスペース&gt;/oracleidentitycloudservice/<メールアドレス></メールアドレス></td>
      <td><code class="language-plaintext highlighter-rouge">&lt;オブジェクト・ストレージ・ネームスペース&gt;</code>は<a href="#0-3-オブジェクトストレージネームスペースの確認">0-3-オブジェクトストレージネームスペースの確認</a>で作成した認証トークン</td>
    </tr>
    <tr>
      <td>パスワード</td>
      <td><a href="#0-2-認証トークンの作成">0-2-認証トークンの作成</a>で作成した認証トークン</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<p>cloneが成功すると”oke-handson”というディレクトリが作成されています。</p>

<p><a href="/ocitutorials/cloud-native/oke-for-intermediates/0資材の取得">ハンズオン資材</a>を”oke-handson”にコピーします。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp</span> <span class="nt">-p</span> oke-atp-handson/<span class="k">*</span> oke-handson/
</code></pre></div></div>

<p>コード・レポジトリからcloneしたディレクトリに移動します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>oke-handson/
</code></pre></div></div>

<p>各自の環境に併せてKubernetesのManifestを1箇所だけ修正します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim k8s/deploy/oke-atp-helidon.yaml
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">oke-atp-helidon</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">LoadBalancer</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="m">8080</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">oke-atp-helidon</span>
<span class="nn">---</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">oke-atp-helidon</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">oke-atp-helidon</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">2</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">oke-atp-helidon</span>
        <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="c1"># The credential files in the secret are base64 encoded twice and hence they need to be decoded for the programs to use them.</span>
      <span class="c1"># This decode-creds initContainer takes care of decoding the files and writing them to a shared volume from which db-app container</span>
      <span class="c1"># can read them and use it for connecting to ATP.</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">oke-atp-helidon</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">iad.ocir.io/orasejapan/handson:${BUILDRUN_HASH}</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">Always</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8080</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">javax.sql.DataSource.workshopDataSource.dataSource.user</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">secretKeyRef</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">customized-db-cred</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s">user_name</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">javax.sql.DataSource.workshopDataSource.dataSource.password</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">secretKeyRef</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">customized-db-cred</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s">password</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">handson</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/db-demo/creds</span>              
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">handson</span>
        <span class="na">configMap</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">okeatp</span>
</code></pre></div></div>

<p>35行目の以下の部分を</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">image</span><span class="pi">:</span> <span class="s">iad.ocir.io/orasejapan/handson:${BUILDRUN_HASH}</span>
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">image</span><span class="pi">:</span> <span class="s">iad.ocir.io/&lt;オブジェクト・ストレージ・ネームスペース&gt;/handson:${BUILDRUN_HASH}</span>
</code></pre></div></div>

<p>&lt;オブジェクト・ストレージ・ネームスペース&gt;は、<a href="#0-3-オブジェクトストレージネームスペースの確認">0-3-オブジェクトストレージネームスペースの確認</a>で確認した値を利用します。　　</p>

<p>上記が完了したら、コンテンツをコミット/プッシュします。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git add <span class="nb">.</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git push
</code></pre></div></div>

<p>これで、サンプルアプリケーションの事前準備は完了です。</p>

<h2 id="3atpのプロビジョニング">3.ATPのプロビジョニング</h2>

<p>このステップでは、OCIコンソールからATPをプロビジョニングし、OKEから接続するための事前準備を行います。</p>

<p>今回のハンズオンでは、OCI Service Operator for Kubernetes(OSOK)を利用してATPのプロビジョニングを行います。<br />
OSOKは、Kubernetes APIおよびKubernetesツールを使用してOracle Cloud Infrastructureリソースを作成、管理および接続できるオープン・ソースのKubernetesアドオンです。<br />
現時点で対応しているサービスは以下の通りです。(今後も続々対応サービスを追加予定です)</p>

<ul>
  <li>Autonomous Database</li>
  <li>MySQL Database</li>
  <li>Streaming</li>
</ul>

<p class="notice--info"><strong>OCI Service Operator for Kubernetes(OSOK)について</strong><br />
OCI Service Operator for Kubernetes(OSOK)については<a href="https://docs.oracle.com/ja-jp/iaas/Content/ContEng/Tasks/contengaddingosok.htm#contengaddingosok">こちら</a>および<a href="https://github.com/oracle/oci-service-operator">GitHub</a>をご確認ください。</p>

<p>OSOKを利用するにはOperator SDKおよびオペレータ・ライフサイクル・マネージャ(OLM)が必要になるため、まずはそちらのインストールから行います。</p>

<p class="notice--info"><strong>Operator SDKとオペレータ・ライフサイクル・マネージャ(OLM)について</strong><br />
OSOKでは、Operator SDKとオペレータ・ライフサイクル・マネージャ(OLM)が必要になります。Operator SDKについては<a href="https://sdk.operatorframework.io/">こちら</a>、オペレータ・ライフサイクル・マネージャ(OLM)については<a href="https://olm.operatorframework.io/">こちら</a>をご確認ください。</p>

<h3 id="3-1-operator-sdkおよびオペレータライフサイクルマネージャolmのインストール">3-1. Operator SDKおよびオペレータ・ライフサイクル・マネージャ(OLM)のインストール</h3>

<p>まずは、Operator SDKのインストールを行います。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">ARCH</span><span class="o">=</span><span class="si">$(</span><span class="k">case</span> <span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span> <span class="k">in </span>x86_64<span class="p">)</span> <span class="nb">echo</span> <span class="nt">-n</span> amd64 <span class="p">;;</span> aarch64<span class="p">)</span> <span class="nb">echo</span> <span class="nt">-n</span> arm64 <span class="p">;;</span> <span class="k">*</span><span class="p">)</span> <span class="nb">echo</span> <span class="nt">-n</span> <span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span> <span class="p">;;</span> <span class="k">esac</span><span class="si">)</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">OS</span><span class="o">=</span><span class="si">$(</span><span class="nb">uname</span> | <span class="nb">awk</span> <span class="s1">'{print tolower($0)}'</span><span class="si">)</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">OPERATOR_SDK_DL_URL</span><span class="o">=</span>https://github.com/operator-framework/operator-sdk/releases/download/v1.12.0
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-LO</span> <span class="k">${</span><span class="nv">OPERATOR_SDK_DL_URL</span><span class="k">}</span>/operator-sdk_<span class="k">${</span><span class="nv">OS</span><span class="k">}</span>_<span class="k">${</span><span class="nv">ARCH</span><span class="k">}</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">ls</span> <span class="nt">-l</span>
</code></pre></div></div>

<p>ここで、<code class="language-plaintext highlighter-rouge">operator-sdk_linux_amd64</code>というバイナリがダウンロードできていることを確認します。<br />
ここからはバイナリの検証を行うためのステップを実行します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gpg <span class="nt">--keyserver</span> keyserver.ubuntu.com <span class="nt">--recv-keys</span> 052996E2A20B5C7E
</code></pre></div></div>

<p>以下のように出力されます。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gpg: requesting key A20B5C7E from hkp server keyserver.ubuntu.com
gpg: /home/takuya_nii/.gnupg/trustdb.gpg: trustdb created
gpg: key A20B5C7E: public key <span class="s2">"Operator SDK (release) &lt;cncf-operator-sdk@cncf.io&gt;"</span> imported
gpg: Total number processed: 1
gpg:               imported: 1  <span class="o">(</span>RSA: 1<span class="o">)</span>
</code></pre></div></div>

<p>検証に必要なファイルを取得します。　　</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-LO</span> <span class="k">${</span><span class="nv">OPERATOR_SDK_DL_URL</span><span class="k">}</span>/checksums.txt
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-LO</span> <span class="k">${</span><span class="nv">OPERATOR_SDK_DL_URL</span><span class="k">}</span>/checksums.txt.asc
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">ls</span> <span class="nt">-l</span>
</code></pre></div></div>

<p>ここで、<code class="language-plaintext highlighter-rouge">checksums.txt.asc</code>と<code class="language-plaintext highlighter-rouge">checksums.txt</code>というファイルがダウンロードできていることを確認します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gpg <span class="nt">-u</span> <span class="s2">"Operator SDK (release) &lt;cncf-operator-sdk@cncf.io&gt;"</span> <span class="nt">--verify</span> checksums.txt.asc
</code></pre></div></div>

<p>以下のような結果が出力されます。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gpg: Signature made Thu 09 Sep 2021 04:59:50 PM UTC using RSA key ID BF9886DB
gpg: Good signature from <span class="s2">"Operator SDK (release) &lt;cncf-operator-sdk@cncf.io&gt;"</span>
gpg: WARNING: This key is not certified with a trusted signature!
gpg:          There is no indication that the signature belongs to the owner.
Primary key fingerprint: xxxx xxxx xxxx xxxx xxxx  xxxx xxxx xxxx xxxx xxxx
     Subkey fingerprint: xxxx xxxx xxxx xxxx xxxx  xxxx xxxx xxxx xxxx xxxx
</code></pre></div></div>

<p>検証結果を確認します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">grep </span>operator-sdk_<span class="k">${</span><span class="nv">OS</span><span class="k">}</span>_<span class="k">${</span><span class="nv">ARCH</span><span class="k">}</span> checksums.txt | <span class="nb">sha256sum</span> <span class="nt">-c</span> -
</code></pre></div></div>

<p>以下のように出力されれば、検証は問題ありません。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>operator-sdk_linux_amd64: OK
</code></pre></div></div>

<p>最後に実行権限を付与します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">chmod</span> +x operator-sdk_<span class="k">${</span><span class="nv">OS</span><span class="k">}</span>_<span class="k">${</span><span class="nv">ARCH</span><span class="k">}</span> <span class="o">&amp;&amp;</span> <span class="nb">mv </span>operator-sdk_<span class="k">${</span><span class="nv">OS</span><span class="k">}</span>_<span class="k">${</span><span class="nv">ARCH</span><span class="k">}</span> operator-sdk
</code></pre></div></div>

<p>これでOperator SDKのインストールは完了です。</p>

<p>続いて、オペレータ・ライフサイクル・マネージャ(OLM)のインストールを行います。</p>

<p>以下のコマンドを実行します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./operator-sdk olm <span class="nb">install</span>
</code></pre></div></div>

<p>以下のように出力されれば問題ありません。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~~~~~
NAME                                            NAMESPACE    KIND                        STATUS
catalogsources.operators.coreos.com                          CustomResourceDefinition    Installed
clusterserviceversions.operators.coreos.com                  CustomResourceDefinition    Installed
installplans.operators.coreos.com                            CustomResourceDefinition    Installed
operatorconditions.operators.coreos.com                      CustomResourceDefinition    Installed
operatorgroups.operators.coreos.com                          CustomResourceDefinition    Installed
operators.operators.coreos.com                               CustomResourceDefinition    Installed
subscriptions.operators.coreos.com                           CustomResourceDefinition    Installed
olm                                                          Namespace                   Installed
operators                                                    Namespace                   Installed
olm-operator-serviceaccount                     olm          ServiceAccount              Installed
system:controller:operator-lifecycle-manager                 ClusterRole                 Installed
olm-operator-binding-olm                                     ClusterRoleBinding          Installed
olm-operator                                    olm          Deployment                  Installed
catalog-operator                                olm          Deployment                  Installed
aggregate-olm-edit                                           ClusterRole                 Installed
aggregate-olm-view                                           ClusterRole                 Installed
global-operators                                operators    OperatorGroup               Installed
olm-operators                                   olm          OperatorGroup               Installed
packageserver                                   olm          ClusterServiceVersion       Installed
operatorhubio-catalog                           olm          CatalogSource               Installed
</code></pre></div></div>

<p>以上で、オペレータ・ライフサイクル・マネージャ(OLM)のインストールは完了です。</p>

<h3 id="3-2-atpのプロビジョニング">3-2. ATPのプロビジョニング</h3>

<p>ここでは、ATPのプロビジョニングを行います。</p>

<p>まずは、以下のコマンドを実行してOKEに対してOSOKオペレータのインストールを行います。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./operator-sdk run bundle iad.ocir.io/oracle/oci-service-operator-bundle:1.0.0
</code></pre></div></div>

<p>以下のように出力されれば問題ありません。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>INFO[0016] Successfully created registry pod: iad-ocir-io-oracle-oci-service-operator-bundle-1-0-0 
INFO[0017] Created CatalogSource: oci-service-operator-catalog 
INFO[0018] OperatorGroup <span class="s2">"operator-sdk-og"</span> created      
INFO[0019] Created Subscription: oci-service-operator-v1-0-0-sub 
INFO[0023] Approved InstallPlan install-bgmnh <span class="k">for </span>the Subscription: oci-service-operator-v1-0-0-sub 
INFO[0023] Waiting <span class="k">for </span>ClusterServiceVersion <span class="s2">"default/oci-service-operator.v1.0.0"</span> to reach <span class="s1">'Succeeded'</span> phase 
INFO[0024]   Waiting <span class="k">for </span>ClusterServiceVersion <span class="s2">"default/oci-service-operator.v1.0.0"</span> to appear 
INFO[0045]   Found ClusterServiceVersion <span class="s2">"default/oci-service-operator.v1.0.0"</span> phase: InstallReady 
INFO[0046]   Found ClusterServiceVersion <span class="s2">"default/oci-service-operator.v1.0.0"</span> phase: Installing 
INFO[0070]   Found ClusterServiceVersion <span class="s2">"default/oci-service-operator.v1.0.0"</span> phase: Succeeded 
INFO[0070] OLM has successfully installed <span class="s2">"oci-service-operator.v1.0.0"</span> 
</code></pre></div></div>

<p>次にATPをプロビジョニングするためのManifestを作成します。</p>

<p>まずは、ATPの管理者パスワードをSecretリソースとして作成します。今回は”TFWorkshop__2000”としてパスワードを作成します。</p>

<p class="notice--info"><strong>Secretについて</strong><br />
Secretリソースについては<a href="https://kubernetes.io/docs/concepts/configuration/secret/">こちら</a>をご確認ください。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create secret generic admin-passwd <span class="nt">--from-literal</span><span class="o">=</span><span class="nv">password</span><span class="o">=</span>TFWorkshop__2000
</code></pre></div></div>

<p>次にWalletファイルのパスワードをSecretリソースとして作成します。<br />
今回は管理者パスワードと同じ”Welcome12345”としてパスワードを作成します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create secret generic wallet-passwd <span class="nt">--from-literal</span><span class="o">=</span><span class="nv">walletpassword</span><span class="o">=</span>Welcome12345
</code></pre></div></div>

<div class="notice--warning">
  <p><strong>Secretを誤って作成してしまった場合</strong><br />
誤って作成してしまった場合等に削除する場合は以下のコマンドを実行。</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl delete secret &lt;secret名&gt;
</code></pre></div></div>

</div>

<p>今回は以下のようなManifestを用意しました。<br />
これはユースケースに応じて柔軟に変更することができます。</p>

<p class="notice--info"><strong>設定可能なパラメータについて</strong><br />
ATPプロビジョニング時に設定可能なパラメータについては<a href="https://github.com/oracle/oci-service-operator/blob/main/docs/adb.md#autonomous-databases-service">こちら</a>をご確認ください。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">oci.oracle.com/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">AutonomousDatabases</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">oke-atp-handson</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">compartmentId</span><span class="pi">:</span> <span class="s">&lt;ご自身のコンパートメントOCID&gt;</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">oke-atp-handson-db</span>
  <span class="na">dbName</span><span class="pi">:</span> <span class="s">oke-atp-handson-db</span>
  <span class="na">dbWorkload</span><span class="pi">:</span> <span class="s">OLTP</span>
  <span class="na">isDedicated</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">dbVersion</span><span class="pi">:</span> <span class="s">19c</span>
  <span class="na">dataStorageSizeInTBs</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">cpuCoreCount</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">adminPassword</span><span class="pi">:</span>
    <span class="na">secret</span><span class="pi">:</span>
      <span class="na">secretName</span><span class="pi">:</span> <span class="s">admin-passwd</span>
  <span class="na">isAutoScalingEnabled</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">isFreeTier</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">licenseModel</span><span class="pi">:</span> <span class="s">LICENSE_INCLUDED</span>
  <span class="na">wallet</span><span class="pi">:</span>
    <span class="na">walletName</span><span class="pi">:</span> <span class="s">oke-atp-handson-wallet</span>
    <span class="na">walletPassword</span><span class="pi">:</span>
      <span class="na">secret</span><span class="pi">:</span>
        <span class="na">secretName</span><span class="pi">:</span> <span class="s">wallet-passwd</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">&lt;ご自身のコンパートメントOCID&gt;</code>の部分をご自身のコンパートメントOCIDに置き換えてください。</p>

<p>OKEに対してManifestを適用します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> atp.yaml 
</code></pre></div></div>

<p>以下のコマンドを実行すると、状況が確認できます。<br />
<code class="language-plaintext highlighter-rouge">status</code>が<code class="language-plaintext highlighter-rouge">Active</code>になるまでしばらくかかるので待機します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get autonomousdatabase
</code></pre></div></div>

<p>以下のように出力されればプロビジョニングは完了です。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME              DBWORKLOAD   STATUS   AGE
oke-atp-handson   OLTP         Active   4m25s
</code></pre></div></div>

<h2 id="4atpへのサンプルデータ登録">4.ATPへのサンプルデータ登録</h2>

<p>このステップでは、SQL Developer Webを利用して、ATPにサンプルデータを登録します。</p>

<h3 id="4-1-サンプルデータの登録">4-1. サンプルデータの登録</h3>

<p>「サービス・コンソール」ボタンをクリックします。</p>

<p><img src="4-001.jpg" alt="4-001.jpg" /></p>

<p>「開発」をクリックします。</p>

<p><img src="4-002.jpg" alt="4-002.jpg" /></p>

<p>「データベース・アクション」をクリックします。</p>

<p><img src="4-003.jpg" alt="4-003.jpg" /></p>

<p>下記項目を入力し、「次」をクリックします。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ユーザ名</td>
      <td>ADMIN</td>
    </tr>
  </tbody>
</table>

<p><img src="4-004.jpg" alt="4-004.jpg" /></p>

<p>下記項目を入力し、「サインイン」をクリックします。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Username</td>
      <td>ATPデータベースのユーザー名。今回は”admin”</td>
    </tr>
    <tr>
      <td>Password</td>
      <td>ATPデータベースのパスワード。今回は”TFWorkshop__2000”</td>
    </tr>
  </tbody>
</table>

<p><img src="4-005.jpg" alt="4-005.jpg" /></p>

<p>「SQL」をクリックします。</p>

<p><img src="4-006.jpg" alt="4-006.jpg" /></p>

<p>ログインしたら、ワークシート内にレポジトリ内(GitHubからcloneしたレポジトリ、コード・レポジトリからcloneしたレポジトリ、どちらでもOKです)の<code class="language-plaintext highlighter-rouge">sql/create_schema.sql</code>に定義されているDDLをコピー&amp;ペーストし、スクリプト(赤枠のボタン)を実行します。</p>

<p><img src="4-007.jpg" alt="4-007.jpg" /></p>

<p>実行後、ブラウザを一度再読み込み(更新)し、「ナビゲータ」メニュから、上記DDLで作成した「HANDSON」を選択します。</p>

<p><img src="4-008.jpg" alt="4-008.jpg" /></p>

<p>SQL Developer WebのWorksheetで<code class="language-plaintext highlighter-rouge">select * from HANDSON.ITEMS</code>を入力して、緑色の矢印「文の実行」アイコンをクリックします。</p>

<p>ITEMSテーブルの結果が表示されます。</p>

<p><img src="4-009.jpg" alt="4-009.jpg" /></p>

<p>これで、サンプルデータの登録は完了しました。</p>

<h3 id="4-2-アプリケーション用のデータベースユーザ名とパスワードの作成">4-2. アプリケーション用のデータベースユーザ名とパスワードの作成</h3>

<p><a href="#3-3-atpのプロビジョニング">3-3. ATPのプロビジョニング</a>では、デフォルトユーザとして”Admin”ユーザでデータベースが作成されます。</p>

<p>ほとんどの場合、アプリケーションがデータベースを利用する際は”Admin”ではなく、別ユーザを作成します。<br />
今回も同様に、ATPを利用するためのデータベースユーザを作成しましょう。<br />
今回のハンズオンでは、ATPのユーザとパスワードを環境変数としてアプリケーションに読み込ませるように設定しています。</p>

<p>ここでは、ATPのユーザとパスワードを環境変数として作成するためにSecretリソースを作成します。</p>

<p>今回は、ATPのユーザを”handson”、パスワードを”Welcome12345”として作成します。<br />
このユーザ名とパスワードは先ほど実行したDDLに定義されています。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create secret generic customized-db-cred <span class="se">\</span>
<span class="nt">--from-literal</span><span class="o">=</span><span class="nv">user_name</span><span class="o">=</span>handson <span class="se">\</span>
<span class="nt">--from-literal</span><span class="o">=</span><span class="nv">password</span><span class="o">=</span>Welcome12345
</code></pre></div></div>

<p>これでアプリケーション用のデータベースユーザ名とパスワードの作成は完了です。</p>

<h2 id="5ciパイプラインの構築">5.CIパイプラインの構築</h2>

<p>ここでは、OCI DevOpsを利用して、CIパイプラインの構築を行います。</p>

<h3 id="5-1-build_specyamlの確認">5-1. build_spec.yamlの確認</h3>

<p>まずは、ビルド定義を行う設定ファイルの確認を行います。</p>

<p>OCI DevOpsでは、Build Specと呼ばれるビルド定義をyaml形式のファイルに記述します。<br />
このファイルでは、コンテナやアプリケーションのビルド、テストなど任意のプロセスを実行することができます。</p>

<p>今回のハンズオンでは、事前に以下のようなファイルを用意しました。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="m">0.1</span>
<span class="na">component</span><span class="pi">:</span> <span class="s">build</span>                    
<span class="na">timeoutInSeconds</span><span class="pi">:</span> <span class="s">10000</span>             
<span class="na">runAs</span><span class="pi">:</span> <span class="s">root</span>                         
<span class="na">shell</span><span class="pi">:</span> <span class="s">bash</span>                        
<span class="na">env</span><span class="pi">:</span>  
  <span class="na">exportedVariables</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">BUILDRUN_HASH</span>               
   
<span class="na">steps</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">Command</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Export</span><span class="nv"> </span><span class="s">variables"</span>
    <span class="na">timeoutInSeconds</span><span class="pi">:</span> <span class="m">40</span>
    <span class="na">command</span><span class="pi">:</span> <span class="pi">|</span>
      <span class="s">export BUILDRUN_HASH=`echo ${OCI_BUILD_RUN_ID} | rev | cut -c 1-7`</span>
      <span class="s">echo "BUILDRUN_HASH: " ${BUILDRUN_HASH}</span>
    <span class="na">onFailure</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">Command</span>
        <span class="na">command</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">echo "Handling Failure"</span>
          <span class="s">echo "Failure successfully handled"</span>
        <span class="na">timeoutInSeconds</span><span class="pi">:</span> <span class="m">40</span>
        <span class="na">runAs</span><span class="pi">:</span> <span class="s">root</span>
  <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">Command</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Docker</span><span class="nv"> </span><span class="s">Build"</span>
    <span class="na">command</span><span class="pi">:</span> <span class="pi">|</span>
      <span class="s">docker build -t handson_image .</span>
    <span class="na">onFailure</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">Command</span>
        <span class="na">command</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">echo "Failured docker build"</span>
        <span class="na">timeoutInSeconds</span><span class="pi">:</span> <span class="m">60</span>
        <span class="na">runAs</span><span class="pi">:</span> <span class="s">root</span>

<span class="na">outputArtifacts</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">handson_image</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">DOCKER_IMAGE</span>
    <span class="na">location</span><span class="pi">:</span> <span class="s">handson_image:latest</span>
</code></pre></div></div>

<p>ここでは、詳細な解説はしませんが、ポイントだけ抑えておきます。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">env</span><span class="pi">:</span>  
  <span class="na">exportedVariables</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">BUILDRUN_HASH</span>  
</code></pre></div></div>

<p>冒頭のこの部分は、後続のCIおよびCDパイプラインで利用可能な変数を定義しています。<br />
今回は、Dockerイメージのタグ付けにこの変数を利用します。</p>

<p>今回のビルドプロセス(yamlファイル内の<code class="language-plaintext highlighter-rouge">step</code>)としては以下の2点に分かれています。</p>

<ul>
  <li>BUILDRUN_HASHの生成</li>
  <li>Dockerイメージのビルド</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">outputArtifacts</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">handson_image</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">DOCKER_IMAGE</span>
    <span class="na">location</span><span class="pi">:</span> <span class="s">handson_image:latest</span>
</code></pre></div></div>

<p>最後尾のこの部分は、ビルドしたDockerイメージを<code class="language-plaintext highlighter-rouge">handson_image</code>という名前で、後続のパイプラインで利用するためにエクスポートしています。</p>

<p>このように、今回利用するビルド定義は比較的シンプルなものです。</p>

<p class="notice--info"><strong>ビルド定義について</strong><br />
ビルド定義に関する詳細は、<a href="https://docs.oracle.com/ja-jp/iaas/Content/devops/using/build_specs.htm">こちら</a>をご確認ください。</p>

<h3 id="5-2-ciパイプラインの構築">5-2. CIパイプラインの構築</h3>

<p>ここからは、CIパイプラインの構築を行います。</p>

<p>まず、ビルドしたコンテナイメージをOCIRにpushする際に利用するビルド成果物(今回はコンテナイメージ)の定義を行います。</p>

<p>「開発者」メニューの「DevOps」カテゴリにある「プロジェクト」をクリックします。</p>

<p><img src="5-001.jpg" alt="5-001.jpg" /></p>

<p>一覧にある<img src="5-002.jpg" alt="5-002.jpg" />をクリックします。</p>

<p>「DevOpsプロジェクト・リソース」にある「アーティファクト」をクリックします。</p>

<p><img src="5-003.jpg" alt="5-003.jpg" /></p>

<p><img src="5-004.jpg" alt="5-004.jpg" />をクリックします。</p>

<p>以下の項目を入力します。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>名前</td>
      <td>handson-image</td>
    </tr>
    <tr>
      <td>タイプ</td>
      <td>コンテナ・レジストリ</td>
    </tr>
    <tr>
      <td>コンテナ・レジストリのイメージへの完全修飾パスを入力してください</td>
      <td>nrt.ocir.io/&lt;オブジェクト・ストレージネーム・スペース&gt;/handson:${BUILDRUN_HASH}</td>
    </tr>
    <tr>
      <td>このアーティファクトで使用するパラメータの置換え</td>
      <td>はい、プレースホルダを置き換えます</td>
    </tr>
  </tbody>
</table>

<p><img src="5-005.jpg" alt="5-005.jpg" /></p>

<p><img src="5-006.jpg" alt="5-006.jpg" />をクリックします。</p>

<p>これにより、後続で作成するビルドパイプラインにおいて、ビルドプロセスで出力したビルド成果物(今回はコンテナイメージ)を定義したコンテナレジストリ(今回は<code class="language-plaintext highlighter-rouge">nrt.ocir.io/&lt;オブジェクト・ストレージネーム・スペース&gt;/handson:${BUILDRUN_HASH}</code>にpushすることができます。</p>

<p>次に、「DevOpsプロジェクト・リソース」にある「ビルド・パイプライン」をクリックします。</p>

<p><img src="5-007.jpg" alt="5-007.jpg" /></p>

<p><img src="5-008.jpg" alt="5-008.jpg" />をクリックします。</p>

<p>以下の項目を入力します。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>名前</td>
      <td>handson_build</td>
    </tr>
  </tbody>
</table>

<p><img src="5-009.jpg" alt="5-009.jpg" /></p>

<p><img src="5-010.jpg" alt="5-010.jpg" />をクリックします。</p>

<p>一覧にある<img src="5-011.jpg" alt="5-011.jpg" />をクリックします。</p>

<p>表示された画面中央にある一覧にある<img src="5-012.jpg" alt="5-012.jpg" />をクリックし、<img src="5-013.jpg" alt="5-013.jpg" />をクリックします。</p>

<p>「マネージド・ビルド」を選択し、<img src="5-015.jpg" alt="5-015.jpg" />をクリックします。</p>

<p><img src="5-014.jpg" alt="5-014.jpg" /></p>

<p>以下の項目を入力します。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
      <th>説明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ステージ名</td>
      <td>image_build</td>
      <td> </td>
    </tr>
    <tr>
      <td>ビルド指定ファイルパス</td>
      <td>build_spec.yaml</td>
      <td>後続で設定する「プライマリ・コード・リポジトリ」に配置しているビルド定義ファイルのパス。今回はプロジェクト直下に配置</td>
    </tr>
  </tbody>
</table>

<p><img src="5-016.jpg" alt="5-016.jpg" /></p>

<p><img src="5-017.jpg" alt="5-017.jpg" />をクリックします。</p>

<p>「プライマリ・コード・レポジトリ」の<img src="5-022.jpg" alt="5-022.jpg" />をクリックします。</p>

<p>以下の項目を入力します。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
      <th>説明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ソース・接続タイプ</td>
      <td>OCIコード・レポジトリ</td>
      <td>“oke-handson”にチェック</td>
    </tr>
    <tr>
      <td>ブランチ名の選択</td>
      <td>main</td>
      <td> </td>
    </tr>
    <tr>
      <td>ソース名の作成</td>
      <td>handson</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<p><img src="5-018.jpg" alt="5-018.jpg" /></p>

<p><img src="5-019.jpg" alt="5-019.jpg" />をクリックします。</p>

<p>以下のようになります。</p>

<p><img src="5-020.jpg" alt="5-020.jpg" /></p>

<p><img src="5-021.jpg" alt="5-021.jpg" />をクリックします。</p>

<p>次に、先ほど作成した「build_image」の下部にある<img src="5-012.jpg" alt="5-012.jpg" />をクリックし、<img src="5-013.jpg" alt="5-013.jpg" />をクリックします。</p>

<p>「アーティファクトの配信」を選択し、<img src="5-015.jpg" alt="5-015.jpg" />をクリックします。</p>

<p><img src="5-023.jpg" alt="5-023jpg" /></p>

<p>以下の項目を入力します。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>名前</td>
      <td>image_push</td>
    </tr>
  </tbody>
</table>

<p><img src="5-024.jpg" alt="5-024jpg" /></p>

<p><img src="5-025.jpg" alt="5-025jpg" />をクリックします。</p>

<p>「handson-image」にチェックを入れて、<img src="5-027.jpg" alt="5-027jpg" />をクリックします。</p>

<p><img src="5-026.jpg" alt="5-026jpg" /></p>

<p>「アーティファクトとビルド結果の関連付け」内の以下の項目を入力します。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
      <th>説明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ビルド構成/結果アーティファクト名</td>
      <td>handson_image</td>
      <td><code class="language-plaintext highlighter-rouge">build_spec.yaml</code>の<code class="language-plaintext highlighter-rouge">outputArtifacts</code>で定義した名前(<a href="#5-1-build_specyamlの確認">5-1-build_specyamlの確認</a>を参照)。今回は<code class="language-plaintext highlighter-rouge">handson_image</code></td>
    </tr>
  </tbody>
</table>

<p><img src="5-029.jpg" alt="5-029jpg" /></p>

<p><img src="5-028.jpg" alt="5-028jpg" />をクリックします。</p>

<p>これで、CIパイプラインの構築は完了です。</p>

<h3 id="5-2-トリガーの作成">5-2. トリガーの作成</h3>

<p>ここでは、OCIコードレポジトリに更新があったタイミングでCIパイプラインを起動できるようにトリガーを設定します。</p>

<p>「開発者」メニューの「DevOps」カテゴリにある「プロジェクト」をクリックします。</p>

<p><img src="5-001.jpg" alt="5-001.jpg" /></p>

<p>一覧にある<img src="5-002.jpg" alt="5-002.jpg" />をクリックします。</p>

<p>「DevOpsプロジェクト・リソース」にある「トリガー」をクリックします。</p>

<p><img src="5-030.jpg" alt="5-030.jpg" /></p>

<p><img src="5-031.jpg" alt="5-031.jpg" />をクリックします。</p>

<p>以下の項目を入力します。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
      <th>説明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>名前</td>
      <td>handson-trigger</td>
      <td> </td>
    </tr>
    <tr>
      <td>ソース接続</td>
      <td>OCIコード・レポジトリ</td>
      <td> </td>
    </tr>
    <tr>
      <td>コード・レポジトリの選択</td>
      <td>oke-handson</td>
      <td><img src="5-033.jpg" alt="5-033.jpg" />をクリックし、”oke-handson”をチェック</td>
    </tr>
  </tbody>
</table>

<p><img src="5-032.jpg" alt="5-032.jpg" /></p>

<p><img src="5-034.jpg" alt="5-034.jpg" />をクリックします。</p>

<p>以下の項目を入力します。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
      <th>説明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ビルド・パイプラインの選択</td>
      <td>handson_build</td>
      <td><img src="5-033.jpg" alt="5-033.jpg" />をクリックし、”handson_build”をチェック</td>
    </tr>
    <tr>
      <td>イベント</td>
      <td>“プッシュ”にチェック</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<p><img src="5-035.jpg" alt="5-035.jpg" />をクリックします。</p>

<p><img src="5-036.jpg" alt="5-036.jpg" />をクリックします。</p>

<p>以下のようになります。</p>

<p><img src="5-037.jpg" alt="5-037.jpg" /></p>

<p><img src="5-038.jpg" alt="5-038.jpg" />をクリックします。</p>

<p>これで、トリガーの作成は完了です。</p>

<h2 id="6cdパイプラインの構築">6.CDパイプラインの構築</h2>

<p>ここでは、CDパイプラインを構築していきます。</p>

<h3 id="6-1-アーティファクトレジストリへのmanifestファイルの登録">6-1. アーティファクト・レジストリへのManifestファイルの登録</h3>

<p>ここでは、CDパイプラインでManifestを利用するためにアーティファクト・レジストリへManifestファイルの登録を行います。</p>

<p>「開発者」メニューの「コンテナとアーティファクト」カテゴリにある「アーティファクト・レジストリ」をクリックします。</p>

<p><img src="6-001.jpg" alt="6-001.jpg" /></p>

<p><img src="6-002.jpg" alt="6-002.jpg" />をクリックします。</p>

<p>以下の項目を入力し、<img src="6-004.jpg" alt="6-004.jpg" />をクリックします。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>名前</td>
      <td>oke-handson</td>
    </tr>
  </tbody>
</table>

<p><img src="6-003.jpg" alt="6-003.jpg" /></p>

<p><img src="6-005.jpg" alt="6-005.jpg" />をクリックします。</p>

<p>以下の項目を入力します。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
      <th> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>アーティファクト・パス</td>
      <td>deploy.yaml</td>
      <td> </td>
    </tr>
    <tr>
      <td>バージョン</td>
      <td>v0.1</td>
      <td> </td>
    </tr>
    <tr>
      <td>Upload method</td>
      <td>Cloud Shell</td>
      <td><code class="language-plaintext highlighter-rouge">コピー</code>をクリック</td>
    </tr>
  </tbody>
</table>

<p><img src="6-006.jpg" alt="6-006.jpg" /></p>

<p><img src="6-007.jpg" alt="6-007.jpg" />からCloud Shellを起動します。</p>

<p><a href="#2-3-サンプルアプリケーションの事前準備">2-3-サンプルアプリケーションの事前準備</a>でcloneしたディレクトリに移動します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>oke-handson
</code></pre></div></div>

<p>先ほどコピーしたコマンドの最後尾の部分<code class="language-plaintext highlighter-rouge">--content-body ./&lt;file-name&gt;</code>を<code class="language-plaintext highlighter-rouge">./k8s/deploy/oke-atp-helidon.yaml</code>に差し替えます。</p>

<p>例えば、以下のようなコマンドになります。</p>

<p><code class="language-plaintext highlighter-rouge">oci artifacts generic artifact upload-by-path -repository-id ocid1.artifactrepository.oc1.iad.0.amaaaaaajv6lhnia763snwz7266nirmhsg6nmxtdttmvamkmuwnpjbnzequa --artifact-path deploy.yaml --artifact-version v0.1 --content-body ./k8s/deploy/oke-atp-helidon.yaml</code></p>

<p>これを実行します。</p>

<p>以下のようなレスポンスが返却されれば問題ありません。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"artifact-path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"deploy.yaml"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"compartment-id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ocid1.tenancy.oc1..aaaaaaaar7rz6wnonqc4256wxjez577mgyql55m55uny4nrhdgyay6cptfta"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"defined-tags"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Oracle-Tags"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"CreatedBy"</span><span class="p">:</span><span class="w"> </span><span class="s2">"oracleidentitycloudservice/takuya0624030105240301@gmail.com"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"CreatedOn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2021-11-16T03:45:12.546Z"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"display-name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"deploy.yaml:v0.1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"freeform-tags"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ocid1.genericartifact.oc1.iad.0.amaaaaaajv6lhniayny6skwl6dbajcibkup5tmsxsvkeyhpavntrbrk4mjjq"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"lifecycle-state"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AVAILABLE"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"repository-id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ocid1.artifactrepository.oc1.iad.0.amaaaaaajv6lhnia763snwz7266nirmhsg6nmxtdttmvamkmuwnpjbnzequa"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"sha256"</span><span class="p">:</span><span class="w"> </span><span class="s2">"7415c1c9ba36d7b2d8c1af64fc7b17b4d007259b3be91a9b2df323a5e670803d"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"size-in-bytes"</span><span class="p">:</span><span class="w"> </span><span class="mi">1593</span><span class="p">,</span><span class="w">
    </span><span class="nl">"time-created"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2021-11-16T03:45:12.712000+00:00"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"v0.1"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>アーティファクト・レジストリ上でも以下のように確認ができます。</p>

<p><img src="6-008.jpg" alt="6-008.jpg" /></p>

<p>これで、アーティファクト・レジストリへのManifestファイルの登録は完了です。</p>

<h3 id="6-2-oci-devopsへのoke環境の登録">6-2. OCI DevOpsへのOKE環境の登録</h3>

<p>ここでは、OKEへサンプルアプリケーションをデプロイするためにOKE環境をOCI DevOpsへ登録します。</p>

<p>「開発者」メニューの「DevOps」カテゴリにある「プロジェクト」をクリックします。</p>

<p><img src="5-001.jpg" alt="5-001.jpg" /></p>

<p>一覧にある<img src="5-002.jpg" alt="5-002.jpg" />をクリックします。</p>

<p>「DevOpsプロジェクト・リソース」にある「環境」をクリックします。</p>

<p><img src="6-009.jpg" alt="6-009.jpg" /></p>

<p><img src="6-010.jpg" alt="6-010.jpg" />をクリックします。</p>

<p>以下の項目を入力します。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>環境タイプ</td>
      <td>Oracle Kubernetesエンジン</td>
    </tr>
    <tr>
      <td>名前</td>
      <td>handson-env</td>
    </tr>
  </tbody>
</table>

<p><img src="6-011.jpg" alt="6-011.jpg" /></p>

<p><img src="6-012.jpg" alt="6-012.jpg" />をクリックします。</p>

<p>以下の項目を入力します。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>リージョン</td>
      <td>ご自身がお使いのリージョン</td>
    </tr>
    <tr>
      <td>コンパートメント</td>
      <td>ご自身がお使いのコンパートメント</td>
    </tr>
    <tr>
      <td>クラスタ</td>
      <td>cluster1</td>
    </tr>
  </tbody>
</table>

<p><img src="6-013.jpg" alt="6-013.jpg" /></p>

<p><img src="6-014.jpg" alt="6-014.jpg" />をクリックします。</p>

<p>これで、OKE環境のOCI DevOpsへの登録は完了です。</p>

<h3 id="6-3-cdパイプラインの構築">6-3. CDパイプラインの構築</h3>

<p>ここでは、OKEへサンプルアプリケーションをデプロイするためのCDパイプラインを構築します。</p>

<p>まずは、OKEへのデプロイ時に利用するManifestをデプロイ・パイプラインで利用できるように設定を行います。</p>

<p>「開発者」メニューの「DevOps」カテゴリにある「プロジェクト」をクリックします。</p>

<p><img src="5-001.jpg" alt="5-001.jpg" /></p>

<p>一覧にある<img src="5-002.jpg" alt="5-002.jpg" />をクリックします。</p>

<p>「DevOpsプロジェクト・リソース」にある「アーティファクト」をクリックします。</p>

<p><img src="5-003.jpg" alt="5-003.jpg" /></p>

<p><img src="5-004.jpg" alt="5-004.jpg" />をクリックします。</p>

<p>以下の項目を入力します。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>名前</td>
      <td>handson_manifest</td>
    </tr>
    <tr>
      <td>タイプ</td>
      <td>Kubernetesマニフェスト</td>
    </tr>
    <tr>
      <td>アーティファクト・ソース</td>
      <td>アーティファクト・レジストリ・レポジトリ</td>
    </tr>
    <tr>
      <td>アーティファクト・レジストリ・リポジトリの選択</td>
      <td><img src="6-016.jpg" alt="6-016.jpg" />をクリックし、<a href="#6-1-アーティファクトレジストリへのmanifestファイルの登録">6-1-アーティファクトレジストリへのmanifestファイルの登録</a>で登録したアーティファクト・レジストリを選択</td>
    </tr>
    <tr>
      <td>アーティファクトの選択</td>
      <td><img src="6-016.jpg" alt="6-016.jpg" />をクリックし、<a href="#6-1-アーティファクトレジストリへのmanifestファイルの登録">6-1-アーティファクトレジストリへのmanifestファイルの登録</a>で登録したアーティファクト(deploy.yaml:v0.1)を選択</td>
    </tr>
  </tbody>
</table>

<p><img src="6-018.jpg" alt="6-018.jpg" /></p>

<p><img src="6-017.jpg" alt="6-017.jpg" />をクリックします。</p>

<p>続いて、パイプラインの構築に入ります。</p>

<p>「開発者」メニューの「DevOps」カテゴリにある「プロジェクト」をクリックします。</p>

<p><img src="5-001.jpg" alt="5-001.jpg" /></p>

<p>一覧にある<img src="5-002.jpg" alt="5-002.jpg" />をクリックします。</p>

<p>「DevOpsプロジェクト・リソース」にある「デプロイメント・パイプライン」をクリックします。</p>

<p><img src="6-015.jpg" alt="6-015.jpg" /></p>

<p><img src="6-019.jpg" alt="6-019.jpg" />をクリックします。</p>

<p>以下の項目を入力します。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>名前</td>
      <td>handson_deploy</td>
    </tr>
  </tbody>
</table>

<p><img src="6-020.jpg" alt="6-020.jpg" /></p>

<p><img src="6-021.jpg" alt="6-021.jpg" />をクリックします。</p>

<p>表示された画面中央にある一覧にある<img src="5-012.jpg" alt="5-012.jpg" />をクリックし、<img src="5-013.jpg" alt="5-013.jpg" />をクリックします。</p>

<p><img src="6-023.jpg" alt="6-023.jpg" />をクリックします。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ステージ名</td>
      <td>handson_deploy</td>
    </tr>
    <tr>
      <td>環境</td>
      <td><a href="#6-2-oci-devopsへのoke環境の登録">6-2-oci-devopsへのoke環境の登録</a>で登録した環境。今回は<code class="language-plaintext highlighter-rouge">handson-dev</code></td>
    </tr>
    <tr>
      <td>1つ以上のアーティファクトを選択します</td>
      <td><img src="6-026.jpg" alt="6-026.jpg" />を選択し、先ほど作成したアーティファクト(<code class="language-plaintext highlighter-rouge">handson_manifest</code>)を選択</td>
    </tr>
  </tbody>
</table>

<p><img src="6-024.jpg" alt="6-024.jpg" /></p>

<p><img src="6-025.jpg" alt="6-025.jpg" />をクリックします。</p>

<p>これで、CDパイプラインの構築は完了です。</p>

<h3 id="6-4-ciパイプラインへのcdパイプライン起動ステップの追加">6-4. CIパイプラインへのCDパイプライン起動ステップの追加</h3>

<p>最後に、CIパイプラインから自動的にCDパイプラインが起動できるようにパイプラインを構築します。</p>

<p>「開発者」メニューの「DevOps」カテゴリにある「プロジェクト」をクリックします。</p>

<p><img src="5-001.jpg" alt="5-001.jpg" /></p>

<p>一覧にある<img src="5-002.jpg" alt="5-002.jpg" />をクリックします。</p>

<p>次に、「DevOpsプロジェクト・リソース」にある「ビルド・パイプライン」をクリックします。</p>

<p><img src="5-007.jpg" alt="5-007.jpg" /></p>

<p><img src="6-027.jpg" alt="6-027.jpg" />をクリックします。</p>

<p>次に、<a href="#5-2-ciパイプラインの構築">5-2-ciパイプラインの構築</a>で作成した「image_push」の下部にある<img src="5-012.jpg" alt="5-012.jpg" />をクリックし、<img src="5-013.jpg" alt="5-013.jpg" />をクリックします。</p>

<p>以下を選択します。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>オプション</td>
      <td>デプロイメントのトリガー</td>
    </tr>
  </tbody>
</table>

<p><img src="6-028.jpg" alt="6-028.jpg" /></p>

<p><img src="6-029.jpg" alt="6-029.jpg" />をクリックします。</p>

<p>以下の項目を入力します。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
      <th>説明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ステージ名</td>
      <td>handson_deploy_call</td>
      <td><img src="6-032.jpg" alt="6-032.jpg" />をクリックし、<a href="#6-3-cdパイプラインの構築">6-3-cdパイプラインの構築</a>で構築したCDパイプライン(<code class="language-plaintext highlighter-rouge">handson_deploy</code>)を選択</td>
    </tr>
  </tbody>
</table>

<p><img src="6-030.jpg" alt="6-030.jpg" /></p>

<p><img src="6-031.jpg" alt="6-031.jpg" />をクリックします。</p>

<p>これで、CDパイプラインの構築は完了です。</p>

<h2 id="7アプリケーションのデプロイ">7.アプリケーションのデプロイ</h2>

<p>ここでは、これまで構築してきたCI/CDパイプラインを実行し、サンプルアプリケーションの確認を行います。</p>

<p>今回は手動実行で行います。(自動でのCI/CDは<a href="#8アプリケーションの再デプロイ">8アプリケーションの再デプロイ</a>で行います)</p>

<p>「開発者」メニューの「DevOps」カテゴリにある「プロジェクト」をクリックします。</p>

<p><img src="5-001.jpg" alt="5-001.jpg" /></p>

<p>一覧にある<img src="5-002.jpg" alt="5-002.jpg" />をクリックします。</p>

<p>次に、「DevOpsプロジェクト・リソース」にある「ビルド・パイプライン」をクリックします。</p>

<p><img src="5-007.jpg" alt="5-007.jpg" /></p>

<p><img src="6-027.jpg" alt="6-027.jpg" />をクリックします。</p>

<p>画面右上にある<img src="7-001.jpg" alt="7-001.jpg" />をクリックします。</p>

<p><img src="7-002.jpg" alt="7-002.jpg" />をクリックします。</p>

<p>このような画面が表示され、ビルドパイプラインが開始されます。</p>

<p><img src="7-003.jpg" alt="7-003.jpg" /></p>

<p>ビルドパイプラインが完了したら、<a href="/ocitutorials/cloud-native/oke-for-commons/#3cli実行環境cloud-shellの準備">Cloud Shellを起動</a>し、
以下のコマンドを実行します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get service
</code></pre></div></div>

<p><strong>コマンド結果</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME        STATUS   ROLES   AGE   VERSION   INTERNAL-IP   EXTERNAL-IP       OS-IMAGE                  KERNEL-VERSION                   CONTAINER-RUNTIME
10.0.24.2   Ready    node    1d    v1.13.5   10.0.24.2     xxx.xxx.xxx.xxx   Oracle Linux Server 7.6   4.14.35-1902.2.0.el7uek.x86_64   docker://18.9.1
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">EXTERNAL-IP</code>の部分の<code class="language-plaintext highlighter-rouge">xxx.xxx.xxx.xxx</code>がパブリックIP(OCIのパブリックLoadBalabncerのIPアドレス)になります。</p>

<p>Webブラウザを起動し、<code class="language-plaintext highlighter-rouge">http://パブリックIP</code>にアクセスしてみましょう。</p>

<p>Webアプリケーションが表示されたら成功です。</p>

<p><img src="7-004.jpg" alt="7-004.jpg" /></p>

<h2 id="8アプリケーションの再デプロイ">8.アプリケーションの再デプロイ</h2>

<p>ここでは、アプリケーションの変更とともにCI/CDを体験していただきます。</p>

<h3 id="8-1-アプリケーションのヘッダー画像の変更">8-1. アプリケーションのヘッダー画像の変更</h3>

<p><a href="/ocitutorials/cloud-native/oke-for-commons/#3cli実行環境cloud-shellの準備">Cloud Shellを起動</a>します。</p>

<p><code class="language-plaintext highlighter-rouge">oke-handson</code>ディレクトリに移動します。</p>

<p>以下のコマンドを実行し、イメージファイルを更新します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp </span>src/main/resources/web/images/forsale_new2.jpg src/main/resources/web/images/forsale.jpg
</code></pre></div></div>

<p>リポジトリへCommitします。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git add <span class="nb">.</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git commit <span class="nt">-m</span> <span class="s2">"トップページのイメージを変更"</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git push
</code></pre></div></div>

<h3 id="8-2-アプリケーションの反映確認">8-2. アプリケーションの反映確認</h3>

<p><a href="#7-1-アプリケーションのヘッダー画像の変更">7-1-アプリケーションのヘッダー画像の変更</a>でのgit pushをトリガーにOCI DevOps上のCI/CDパイプラインが起動しているので、コンソールから確認します。</p>

<p>「開発者」メニューの「DevOps」カテゴリにある「プロジェクト」をクリックします。</p>

<p><img src="5-001.jpg" alt="5-001.jpg" /></p>

<p>一覧にある<img src="5-002.jpg" alt="5-002.jpg" />をクリックします。</p>

<p>次に、「DevOpsプロジェクト・リソース」にある「ビルド履歴」をクリックします。</p>

<p><img src="8-001.jpg" alt="8-001.jpg" /></p>

<p>ビルド履歴の一覧に先ほどのgit pushでトリガされた履歴が表示されます。</p>

<p><img src="8-002.jpg" alt="8-002.jpg" /></p>

<p>ビルドが完了したら、<a href="#7アプリケーションのデプロイ">7アプリケーションのデプロイ</a>で確認したパブリックIPに再度アクセスします。<br />
背景画像が変更されていることが確認できます。</p>

<p><img src="8-003.jpg" alt="8-003.jpg" /></p>

<p>これで、本ハンズオンは終了です！！お疲れ様でした！！</p>

<h2 id="9オプション今回利用したアプリケーションに関する補足">9.【オプション】今回利用したアプリケーションに関する補足</h2>

<p>ここでは、デプロイに使用したmanifestファイル(oke-atp-helidon.yaml)の詳細について解説します。</p>

<p>今回は、ATPのユーザ名とパスワードをkubernetesのSecretリソースとして作成し、それらをコンテナ上の環境変数として読み込みアプリケーションで使用しました。<br />
今回のハンズオンでは、<code class="language-plaintext highlighter-rouge">oke-atp-helidon.yaml</code>というmanifestを利用しました。</p>

<p>上記manifestファイルは以下のようになっています。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">oke-atp-helidon</span>
<span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
<span class="na">spec</span><span class="pi">:</span>
<span class="na">type</span><span class="pi">:</span> <span class="s">LoadBalancer</span>
<span class="na">ports</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="m">8080</span>
<span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">oke-atp-helidon</span>
<span class="nn">---</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">oke-atp-helidon</span>
<span class="na">spec</span><span class="pi">:</span>
<span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">oke-atp-helidon</span>
<span class="na">replicas</span><span class="pi">:</span> <span class="m">2</span>
<span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
    <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">oke-atp-helidon</span>
        <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
    <span class="na">spec</span><span class="pi">:</span>
    <span class="c1"># The credential files in the secret are base64 encoded twice and hence they need to be decoded for the programs to use them.</span>
    <span class="c1"># This decode-creds initContainer takes care of decoding the files and writing them to a shared volume from which db-app container</span>
    <span class="c1"># can read them and use it for connecting to ATP.</span>
    <span class="na">containers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">oke-atp-helidon</span>
        <span class="s">image</span><span class="err">:</span> <span class="s">iad.ocir.io/orasejapan/workshop/okeatpapp:latest</span>
        <span class="s">imagePullPolicy</span><span class="err">:</span> <span class="s">Always</span>
        <span class="s">ports</span><span class="err">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8080</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">javax.sql.DataSource.workshopDataSource.dataSource.user</span>
        <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">secretKeyRef</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">customized-db-cred</span>
            <span class="na">key</span><span class="pi">:</span> <span class="s">user_name</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">javax.sql.DataSource.workshopDataSource.dataSource.password</span>
        <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">secretKeyRef</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">customized-db-cred</span>
            <span class="na">key</span><span class="pi">:</span> <span class="s">password</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">handson</span>
        <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/db-demo/creds</span> 
    <span class="na">imagePullSecrets</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">workshop-ocirsecret</span>
    <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">handson</span>
        <span class="s">configMap</span><span class="err">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">okeatp</span>
</code></pre></div></div>

<p>40-49行目に注目してみましょう。
以下の行は、データベースのユーザとパスワードをコンテナにおける環境変数として設定しており、その値をcustomized-db-credというSecretから読み込んでいます。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">javax_sql_DataSource_workshopDataSource_dataSource_user</span>
    <span class="na">valueFrom</span><span class="pi">:</span>
        <span class="na">secretKeyRef</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">customized-db-cred</span>
        <span class="na">key</span><span class="pi">:</span> <span class="s">user_name</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">javax_sql_DataSource_workshopDataSource_dataSource_password</span>
    <span class="na">valueFrom</span><span class="pi">:</span>
        <span class="na">secretKeyRef</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">customized-db-cred</span>
        <span class="na">key</span><span class="pi">:</span> <span class="s">password</span>
</code></pre></div></div>

<p>今回の場合は、ユーザ名を<code class="language-plaintext highlighter-rouge">javax_sql_DataSource_workshopDataSource_dataSource_user</code>、パスワードを<code class="language-plaintext highlighter-rouge">javax_sql_DataSource_workshopDataSource_dataSource_password</code>という名前の環境変数としてそれぞれSecretリソースから読み込んでいます。</p>

<p>今回は”customized-db-cred”というSecretリソースを<a href="#6-3atpのユーザの作成">ATPユーザの作成</a>の手順で作成しました。</p>

<p>このようにkubernetesでは、アプリケーションで使用する機密情報をSecretリソースとして隠蔽し、その値を環境変数として読み込ませることができます。<br />
詳細については<a href="https://kubernetes.io/docs/concepts/configuration/secret/">公式ドキュメント</a>をご確認ください。</p>

<p>次にWalletファイルについて解説します。</p>

<p>再度manifestファイルを確認してみましょう。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">oke-atp-helidon</span>
<span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
<span class="na">spec</span><span class="pi">:</span>
<span class="na">type</span><span class="pi">:</span> <span class="s">LoadBalancer</span>
<span class="na">ports</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="m">8080</span>
<span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">oke-atp-helidon</span>
<span class="nn">---</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">oke-atp-helidon</span>
<span class="na">spec</span><span class="pi">:</span>
<span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">oke-atp-helidon</span>
<span class="na">replicas</span><span class="pi">:</span> <span class="m">2</span>
<span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
    <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">oke-atp-helidon</span>
        <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
    <span class="na">spec</span><span class="pi">:</span>
    <span class="c1"># The credential files in the secret are base64 encoded twice and hence they need to be decoded for the programs to use them.</span>
    <span class="c1"># This decode-creds initContainer takes care of decoding the files and writing them to a shared volume from which db-app container</span>
    <span class="c1"># can read them and use it for connecting to ATP.</span>
    <span class="na">containers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">oke-atp-helidon</span>
        <span class="s">image</span><span class="err">:</span> <span class="s">iad.ocir.io/orasejapan/workshop/okeatpapp:latest</span>
        <span class="s">imagePullPolicy</span><span class="err">:</span> <span class="s">Always</span>
        <span class="s">ports</span><span class="err">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8080</span>
        <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">javax.sql.DataSource.workshopDataSource.dataSource.user</span>
        <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">secretKeyRef</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">customized-db-cred</span>
            <span class="na">key</span><span class="pi">:</span> <span class="s">user_name</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">javax.sql.DataSource.workshopDataSource.dataSource.password</span>
        <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">secretKeyRef</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">customized-db-cred</span>
            <span class="na">key</span><span class="pi">:</span> <span class="s">password</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">handson</span>
        <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/db-demo/creds</span> 
    <span class="na">imagePullSecrets</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">workshop-ocirsecret</span>
    <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">handson</span>
        <span class="s">configMap</span><span class="err">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">okeatp</span>
</code></pre></div></div>

<p>50-56行目に注目してみましょう。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">handson</span>
        <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/db-demo/creds</span>
    <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">handson</span>
        <span class="s">configMap</span><span class="err">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">okeatp</span>
</code></pre></div></div>

<p>今回は”okeatp”というConfigmapリソースを<a href="#6-3atpのユーザの作成">ATPユーザの作成</a>の手順で作成しました。<br />
ここで作成したリソースを53-56行目で”handson”という名前でPodのボリュームに保持しています。</p>

<p>また、50-52行目では、上記で設定した”handson”リソースをコンテナ上の”/db-demo/creds”というパスにマウントしています。</p>

<p>今回は、このマウントしたリソースを構成ファイル(oke-atp-helidon-handson/src/main/resources/META-INF/microprofile-config.properties)で利用しています。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#</span>
<span class="c1"># Copyright (c) 2018 Oracle and/or its affiliates. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the "License");</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an "AS IS" BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1">#</span>

<span class="c1"># Microprofile server properties</span>
<span class="s">server.port=8080</span>
<span class="s">server.host=0.0.0.0</span>

<span class="s">javax.sql.DataSource.workshopDataSource.dataSourceClassName=oracle.jdbc.pool.OracleDataSource</span>
<span class="s">javax.sql.DataSource.workshopDataSource.dataSource.url=jdbc:oracle:thin:@tfokeatpdb_high?TNS_ADMIN=/db-demo/creds</span>
<span class="s">javax.sql.DataSource.workshopDataSource.maximumPoolSize=5</span>
<span class="s">javax.sql.DataSource.workshopDataSource.minimumIdle=2</span>

<span class="c1"># src/main/resources/web in your source tree</span>
<span class="s">server.static.classpath.location=/web</span>
<span class="c1"># default is index.html</span>
<span class="s">server.static.classpath.welcome=index.html</span>
<span class="c1"># static content path - default is "/"</span>
<span class="c1"># server.static.classpath.context=/static-cp</span>
</code></pre></div></div>

<p>22行目に注目してみましょう。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">javax.sql.DataSource.workshopDataSource.dataSource.url=jdbc:oracle:thin:@Demo_HIGH?TNS_ADMIN=/db-demo/creds</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">jdbc:oracle:thin:@Demo_HIGH?TNS_ADMIN=/db-demo/creds</code>がWalletファイルを読み込んでいる部分になります。<br />
ここに先ほどmanifestでマウントしたパスが設定されています。<br />
これでアプリケーションからKubernetesのConfigmapに設定したWalletファイルを利用することができます。</p>

        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> 更新日時:</strong> <time datetime="2021-11-26T10:15:54+09:00">November 26, 2021</time></p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">共有</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Kubernetes%E3%81%A7%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%A8CI%2FCD%E3%82%92%E4%BD%93%E9%A8%93%E3%81%97%E3%81%A6%E3%81%BF%E3%82%88%E3%81%86%20https%3A%2F%2Foracle-japan.github.io%2Focitutorials%2Fcloud-native-test%2Foke-for-intermediates%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="共有 Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Foracle-japan.github.io%2Focitutorials%2Fcloud-native-test%2Foke-for-intermediates%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="共有 Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Foracle-japan.github.io%2Focitutorials%2Fcloud-native-test%2Foke-for-intermediates%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="共有 LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/ocitutorials/cloud-native-test/devops-for-commons/" class="pagination--pager" title="OCI DevOpsことはじめ
">前へ</a>
    
    
      <a href="#" class="pagination--pager disabled">次へ</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">関連記事</h4>
      <div class="grid__wrapper">
        
      </div>
    </div>
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="検索キーワードを入力してください..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>フォロー</strong></li>
    

    
      
        
          <li><a href="https://twitter.com/#ocijp" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/oracle-japan" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
    

    
      <li><a href="/ocitutorials/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2021 Oracle Cloud Infrastructure チュートリアル. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/ocitutorials/assets/js/main.min.js"></script>




<script src="/ocitutorials/assets/js/lunr/lunr.min.js"></script>
<script src="/ocitutorials/assets/js/lunr/lunr-store.js"></script>
<script src="/ocitutorials/assets/js/lunr/lunr-en.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6W7FEC5CEH"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6W7FEC5CEH', { 'anonymize_ip': false});
</script>







  
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
  
    <script src="/ocitutorials/assets/js/clipboardrouge.js"></script>
  



  </body>
</html>
